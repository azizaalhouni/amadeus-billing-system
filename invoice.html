<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Multi-File Excel Consolidator with Months</title>
    <style>
        body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            direction: rtl;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .description {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
        }

        .upload-section {
            margin: 2rem 0;
            padding: 2rem;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .file-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .file-group h3 {
            margin-top: 0;
            color: #007cba;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-input {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            direction: ltr;
        }

        .file-counter {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
        }

        .file-list {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin: 0.3rem 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .file-name {
            font-weight: 500;
            color: #495057;
            flex-grow: 1;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.9rem;
            margin: 0 1rem;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .add-more-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .add-more-btn:hover {
            background: #138496;
        }

        .clear-all-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .process-btn, .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 0.5rem;
            transition: background-color 0.2s;
        }

        .process-btn:hover:not(:disabled) {
            background: #218838;
        }

        .process-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .download-btn {
            background: #007cba;
        }

        .download-btn:hover {
            background: #005a87;
        }

        .results-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #28a745;
        }

        .results-section h3 {
            color: #28a745;
            margin-top: 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            direction: rtl;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9rem;
            direction: rtl;
        }

        th, td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        .office-id {
            background: #e7f3ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-family: monospace;
        }

        .count-cell {
            text-align: left;
            font-weight: bold;
        }

        .cost-cell {
            text-align: left;
            font-weight: bold;
            color: #dc3545;
        }

        .total-cell {
            background: #d4edda;
            font-weight: bold;
            text-align: left;
        }

        .progress {
            margin: 1rem 0;
            padding: 1rem;
            background: #e7f3ff;
            border-radius: 6px;
            display: none;
        }

        .debug-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }

        .dual-header {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .count-header {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .cost-header {
            background: #ffebee;
            border-left: 3px solid #f44336;
        }

        .file-stats {
            background: #e8f5e8;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #155724;
        }

        .month-info {
            background: #fff3cd;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #856404;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <nav style="
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 1rem 0;
    margin: -2rem -2rem 2rem -2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    ">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
        <h2 style="color: white; margin: 0 0 1rem 0; text-align: center; font-size: 1.5rem;">
           مجموعة معالجة تقارير أماديوس مع الأشهر
        </h2>
        <h2 style="color: white; margin: 0 0 1rem 0; text-align: center; font-size: 1.5rem;">
           Amadeus Reports Processing Suite with Months
        </h2>
        <p style="
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin: 1rem 0 0 0;
            font-size: 0.85rem;
        ">
            الآن يتم إضافة معلومات الأشهر تلقائياً إلى وصف الخدمات في الفواتير
        </p>
        <p style="
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin: 1rem 0 0 0;
            font-size: 0.85rem;
        ">
            Month information is now automatically added to service descriptions in invoices
        </p>
    </div>
</nav>

    <div class="container">
        <h1>موحد ملفات Excel المحسّن مع معلومات الأشهر</h1>
        <h1>Enhanced Excel Files Consolidator with Month Information</h1>

        <p class="description">دمج ملفات متعددة من كل نوع تقرير مع إضافة معلومات الأشهر للفواتير</p>
        <p class="description">Consolidate multiple files with automatic month range extraction for invoices</p>
        
        <div class="upload-section">
            <!-- Bills Master File -->
            <div class="file-group">
                <h3>
                    الملف الرئيسي (bills.xlsx) - Master File
                    <span class="file-counter" id="billsCounter">0</span>
                </h3>
                <input type="file" id="billsFile" class="file-input" accept=".xlsx,.xls" />
                <div class="file-list" id="billsList"></div>
            </div>

            <!-- ATC Files -->
            <div class="file-group">
                <h3>
                    ملفات ATC - ATC Reports
                    <span class="file-counter" id="atcCounter">0</span>
                </h3>
                <input type="file" id="atcFile" class="file-input" accept=".xlsx,.xls" multiple />
                <button class="add-more-btn" onclick="document.getElementById('atcFile').click()">
                    إضافة المزيد من ملفات ATC
                </button>
                <button class="clear-all-btn" onclick="clearFileGroup('atc')">مسح الكل</button>
                <div class="file-list" id="atcList"></div>
                <div class="file-stats" id="atcStats"></div>
                <div class="month-info" id="atcMonths"></div>
            </div>

            <!-- WEP Files -->
            <div class="file-group">
                <h3>
                    ملفات WEP - WEP Reports
                    <span class="file-counter" id="wepCounter">0</span>
                </h3>
                <input type="file" id="wepFile" class="file-input" accept=".xlsx,.xls" multiple />
                <button class="add-more-btn" onclick="document.getElementById('wepFile').click()">
                    إضافة المزيد من ملفات WEP
                </button>
                <button class="clear-all-btn" onclick="clearFileGroup('wep')">مسح الكل</button>
                <div class="file-list" id="wepList"></div>
                <div class="file-stats" id="wepStats"></div>
                <div class="month-info" id="wepMonths"></div>
            </div>

            <!-- PNR Files -->
            <div class="file-group">
                <h3>
                    ملفات PNR - PNR Reports
                    <span class="file-counter" id="pnrCounter">0</span>
                </h3>
                <input type="file" id="pnrFile" class="file-input" accept=".xlsx,.xls" multiple />
                <button class="add-more-btn" onclick="document.getElementById('pnrFile').click()">
                    إضافة المزيد من ملفات PNR
                </button>
                <button class="clear-all-btn" onclick="clearFileGroup('pnr')">مسح الكل</button>
                <div class="file-list" id="pnrList"></div>
                <div class="file-stats" id="pnrStats"></div>
                <div class="month-info" id="pnrMonths"></div>
            </div>

            <!-- MPT Files -->
            <div class="file-group">
                <h3>
                    ملفات MPT - MPT Reports
                    <span class="file-counter" id="mptCounter">0</span>
                </h3>
                <input type="file" id="mptFile" class="file-input" accept=".xlsx,.xls" multiple />
                <button class="add-more-btn" onclick="document.getElementById('mptFile').click()">
                    إضافة المزيد من ملفات MPT
                </button>
                <button class="clear-all-btn" onclick="clearFileGroup('mpt')">مسح الكل</button>
                <div class="file-list" id="mptList"></div>
                <div class="file-stats" id="mptStats"></div>
                <div class="month-info" id="mptMonths"></div>
            </div>

            <!-- MPE Files -->
            <div class="file-group">
                <h3>
                    ملفات MPE - MPE Reports
                    <span class="file-counter" id="mpeCounter">0</span>
                </h3>
                <input type="file" id="mpeFile" class="file-input" accept=".xlsx,.xls" multiple />
                <button class="add-more-btn" onclick="document.getElementById('mpeFile').click()">
                    إضافة المزيد من ملفات MPE
                </button>
                <button class="clear-all-btn" onclick="clearFileGroup('mpe')">مسح الكل</button>
                <div class="file-list" id="mpeList"></div>
                <div class="file-stats" id="mpeStats"></div>
                <div class="month-info" id="mpeMonths"></div>
            </div>

            <div class="progress" id="progressDiv">
                <p id="progressText">جاري معالجة الملفات...</p>
            </div>

            <div class="debug-info" id="debugInfo">
                <h4>معلومات التصحيح:</h4>
                <div id="debugContent"></div>
            </div>

            <button id="processBtn" class="process-btn" disabled>
                معالجة ودمج جميع الملفات مع الأشهر - Process & Consolidate All Files with Months
            </button>
        </div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <h3>معاينة الملخص الموحد مع معلومات الأشهر - Enhanced Consolidated Summary with Month Information</h3>
            <div class="table-container">
                <table id="summaryTable" class="invoice-table">
                    <thead>
                        <tr>
                            <th>رمز المكتب</th>
                            <th>اسم المكتب</th>
                            <th>الاسم العربي</th>
                            <th>رقم IATA</th>
                            <th class="count-header">عدد ATC</th>
                            <th class="cost-header">تكلفة ATC</th>
                            <th class="count-header">عدد WEP</th>
                            <th class="cost-header">تكلفة WEP</th>
                            <th class="count-header">عدد PNR</th>
                            <th class="cost-header">تكلفة PNR</th>
                            <th class="count-header">عدد MPT</th>
                            <th class="cost-header">تكلفة MPT</th>
                            <th class="count-header">عدد MPE</th>
                            <th class="cost-header">تكلفة MPE</th>
                            <th class="total-cell">إجمالي التكلفة</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                    </tbody>
                </table>
            </div>

            <button id="downloadBtn" class="download-btn">
                تحميل ملف الاكسل الموحد - Download Consolidated Excel
            </button>
            
            <button id="generateInvoicesBtn" class="download-btn" style="background: #dc3545; margin-right: 10px;">
                إنشاء فواتير المكاتب مع الأشهر - Generate Invoices with Months
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Enhanced file management system with month tracking
        let fileCollections = {
            bills: [],
            atc: [],
            wep: [],
            pnr: [],
            mpt: [],
            mpe: []
        };

        let consolidatedWorkbook = null;
        let masterSummary = {};
        let officeDetails = {};
        let monthInformation = {
            atc: new Set(),
            wep: new Set(),
            pnr: new Set(),
            mpt: new Set(),
            mpe: new Set()
        };

        // DOM elements
        const fileInputs = {
            bills: document.getElementById('billsFile'),
            atc: document.getElementById('atcFile'),
            wep: document.getElementById('wepFile'),
            pnr: document.getElementById('pnrFile'),
            mpt: document.getElementById('mptFile'),
            mpe: document.getElementById('mpeFile')
        };

        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const generateInvoicesBtn = document.getElementById('generateInvoicesBtn');
        const progressDiv = document.getElementById('progressDiv');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const summaryTableBody = document.getElementById('summaryTableBody');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');

        // Handle file uploads with multiple file support
        Object.keys(fileInputs).forEach(key => {
            fileInputs[key].addEventListener('change', (event) => {
                handleMultipleFileUpload(key, event.target.files);
            });
        });

        function handleMultipleFileUpload(type, fileList) {
            if (!fileList || fileList.length === 0) return;

            const files = Array.from(fileList);
            console.log(`Adding ${files.length} files to ${type} collection`);

            // For bills, only allow one file
            if (type === 'bills') {
                fileCollections[type] = [files[0]]; // Only keep the latest bills file
            } else {
                // For other types, accumulate files (avoid duplicates)
                files.forEach(file => {
                    const isDuplicate = fileCollections[type].some(existingFile => 
                        existingFile.name === file.name && 
                        existingFile.size === file.size &&
                        existingFile.lastModified === file.lastModified
                    );
                    
                    if (!isDuplicate) {
                        fileCollections[type].push(file);
                    }
                });
            }

            updateFileDisplay(type);
            updateProcessButton();
            
            // Clear the input so user can select more files
            fileInputs[type].value = '';
        }

        function updateFileDisplay(type) {
            const files = fileCollections[type];
            const counter = document.getElementById(`${type}Counter`);
            const list = document.getElementById(`${type}List`);
            const stats = document.getElementById(`${type}Stats`);
            const monthsDiv = document.getElementById(`${type}Months`);

            // Update counter
            counter.textContent = files.length;
            counter.style.background = files.length > 0 ? '#28a745' : '#6c757d';

            // Update file list
            if (files.length === 0) {
                list.style.display = 'none';
                if (stats) stats.style.display = 'none';
                if (monthsDiv) monthsDiv.style.display = 'none';
                return;
            }

            list.style.display = 'block';
            list.innerHTML = files.map((file, index) => `
                <div class="file-item">
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                    <button class="remove-btn" onclick="removeFile('${type}', ${index})">حذف</button>
                </div>
            `).join('');

            // Update stats for data files
            if (stats && type !== 'bills') {
                const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                stats.style.display = 'block';
                stats.innerHTML = `
                    <strong>${files.length}</strong> ملف | 
                    المجموع: <strong>${(totalSize / 1024).toFixed(1)} KB</strong>
                `;
            }

            // Update month information display
            if (monthsDiv && type !== 'bills') {
                const months = Array.from(monthInformation[type]).sort((a, b) => a - b);
                if (months.length > 0) {
                    monthsDiv.style.display = 'block';
                    monthsDiv.innerHTML = `الأشهر المتاحة: ${months.join(', ')}`;
                } else {
                    monthsDiv.style.display = 'none';
                }
            }
        }

        function removeFile(type, index) {
            fileCollections[type].splice(index, 1);
            updateFileDisplay(type);
            updateProcessButton();
        }

        function clearFileGroup(type) {
            fileCollections[type] = [];
            monthInformation[type] = new Set();
            updateFileDisplay(type);
            updateProcessButton();
        }

        function updateProcessButton() {
            const hasBills = fileCollections.bills.length > 0;
            const hasDataFiles = fileCollections.atc.length > 0 || 
                                fileCollections.wep.length > 0 || 
                                fileCollections.pnr.length > 0 || 
                                fileCollections.mpt.length > 0 || 
                                fileCollections.mpe.length > 0;
            
            processBtn.disabled = !(hasBills && hasDataFiles);
        }

        // Process all files
        processBtn.addEventListener('click', async () => {
            progressDiv.style.display = 'block';
            debugInfo.style.display = 'block';
            processBtn.disabled = true;
            
            try {
                await processAllFiles();
                displayResults();
                resultsSection.style.display = 'block';
            } catch (error) {
                console.error('Error processing files:', error);
                alert('خطأ في معالجة الملفات: ' + error.message);
                debugContent.innerHTML += `<p><strong>خطأ:</strong> ${error.message}</p>`;
            } finally {
                progressDiv.style.display = 'none';
                processBtn.disabled = false;
            }
        });

        async function processAllFiles() {
            // Reset data
            masterSummary = {};
            Object.keys(monthInformation).forEach(key => {
                monthInformation[key] = new Set();
            });
            
            // Read bills.xlsx
            progressText.textContent = 'قراءة ملف bills.xlsx...';
            const billsData = await readFile(fileCollections.bills[0]);
            consolidatedWorkbook = XLSX.read(billsData);

            // Load office details
            progressText.textContent = 'تحميل تفاصيل المكاتب...';
            loadOfficeDetails();

            // Process each file type
            const dataTypes = ['atc', 'wep', 'pnr', 'mpt', 'mpe'];
            
            for (const fileType of dataTypes) {
                const files = fileCollections[fileType];
                if (files.length > 0) {
                    progressText.textContent = `معالجة ${files.length} ملف ${fileType.toUpperCase()}...`;
                    await processMultipleDataFiles(fileType, files);
                }
            }

            // Create master summary
            progressText.textContent = 'إنشاء الملخص الرئيسي...';
            createMasterSummary();
        }

        async function processMultipleDataFiles(fileType, files) {
            debugContent.innerHTML += `<h4>معالجة ${files.length} ملف ${fileType.toUpperCase()}</h4>`;
            
            // Combined data from all files of this type
            let combinedSummaryData = [];
            let monthsFound = new Set();
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                progressText.textContent = `معالجة ملف ${fileType.toUpperCase()} ${i + 1}/${files.length}: ${file.name}`;
                
                const data = await readFile(file);
                const workbook = XLSX.read(data);
                
                debugContent.innerHTML += `<p>الملف ${i + 1}: ${file.name} - الأوراق: ${workbook.SheetNames.join(', ')}</p>`;
                
                // Find summary sheet
                const possibleSummaryNames = [
                    'Summary by Office ID',
                    'Summary with Costs', 
                    'Combined Summary',
                    'Master_Summary',
                    'Summary',
                    'summary',
                    'SUMMARY',
                    'Sheet1'
                ];
                
                let summarySheetName = null;
                for (const name of possibleSummaryNames) {
                    if (workbook.SheetNames.includes(name)) {
                        summarySheetName = name;
                        break;
                    }
                }
                
                if (!summarySheetName) {
                    summarySheetName = workbook.SheetNames[0];
                }

                debugContent.innerHTML += `<p>الملف ${i + 1}: استخدام الورقة '${summarySheetName}'</p>`;

                if (summarySheetName && workbook.Sheets[summarySheetName]) {
                    const summarySheet = workbook.Sheets[summarySheetName];
                    const summaryData = XLSX.utils.sheet_to_json(summarySheet);
                    
                    debugContent.innerHTML += `<p>الملف ${i + 1}: ${summaryData.length} صف</p>`;
                    
                    // Extract month information from data
                    summaryData.forEach(row => {
                        const month = row['Month'] || row['month'] || row['MONTH'];
                        if (month) {
                            monthsFound.add(parseInt(month));
                        }
                    });
                    
                    // Add file info to each row
                    summaryData.forEach(row => {
                        row._sourceFile = file.name;
                        row._fileIndex = i;
                    });
                    
                    combinedSummaryData = combinedSummaryData.concat(summaryData);
                }
            }

            // Update month information for this file type
            monthInformation[fileType] = monthsFound;
            updateFileDisplay(fileType);

            debugContent.innerHTML += `<p><strong>${fileType.toUpperCase()}: إجمالي ${combinedSummaryData.length} صف من ${files.length} ملف</strong></p>`;
            if (monthsFound.size > 0) {
                debugContent.innerHTML += `<p><strong>الأشهر الموجودة في ${fileType.toUpperCase()}: ${Array.from(monthsFound).sort().join(', ')}</strong></p>`;
            }

            // Process combined data and aggregate by office
            const officeAggregation = {};
            
            combinedSummaryData.forEach((row, index) => {
                const officeId = row['Office ID'] || row['Office Id'] || row['OFFICE ID'] || 
                               row['OfficeID'] || row['ID'] || '';
                
                const totalCount = parseFloat(
                    row['Total Transactions'] || row['Total Count'] || row['Count'] ||
                    row['Total PNR Recalls'] || row['Total Searches'] || row['Number of Transactions'] ||
                    row['TOTAL COUNT'] || row['Transaction Count'] || 0
                );
                
                const totalCost = parseFloat(
                    row['Total Cost'] || row['Cost'] || row['Total Amount'] ||
                    row['Grand Total'] || row['TOTAL COST'] || row['Amount'] || 0
                );

                if (officeId && (!isNaN(totalCount) || !isNaN(totalCost))) {
                    const cleanOfficeId = officeId.toString().trim();
                    
                    if (!officeAggregation[cleanOfficeId]) {
                        officeAggregation[cleanOfficeId] = {
                            totalCount: 0,
                            totalCost: 0,
                            files: new Set(),
                            months: new Set()
                        };
                    }
                    
                    officeAggregation[cleanOfficeId].totalCount += totalCount || 0;
                    officeAggregation[cleanOfficeId].totalCost += totalCost || 0;
                    officeAggregation[cleanOfficeId].files.add(row._sourceFile || 'Unknown');
                    
                    // Add month information
                    const month = row['Month'] || row['month'] || row['MONTH'];
                    if (month) {
                        officeAggregation[cleanOfficeId].months.add(parseInt(month));
                    }
                }
            });

            // Update master summary with aggregated data
            Object.keys(officeAggregation).forEach(officeId => {
                if (!masterSummary[officeId]) {
                    const officeInfo = officeDetails[officeId] || {
                        name: 'مكتب غير معروف',
                        arabicName: 'مكتب غير معروف',
                        iataNumber: 'غير معروف'
                    };
                    
                    masterSummary[officeId] = {
                        officeId: officeId,
                        officeName: officeInfo.name,
                        officeArabicName: officeInfo.arabicName,
                        iataNumber: officeInfo.iataNumber,
                        atcCount: 0, atcCost: 0, atcMonths: new Set(),
                        wepCount: 0, wepCost: 0, wepMonths: new Set(),
                        pnrCount: 0, pnrCost: 0, pnrMonths: new Set(),
                        mptCount: 0, mptCost: 0, mptMonths: new Set(),
                        mpeCount: 0, mpeCost: 0, mpeMonths: new Set()
                    };
                }
                
                const aggData = officeAggregation[officeId];
                masterSummary[officeId][fileType + 'Count'] = aggData.totalCount;
                masterSummary[officeId][fileType + 'Cost'] = aggData.totalCost;
                masterSummary[officeId][fileType + 'Months'] = aggData.months;
            });

            debugContent.innerHTML += `<p><strong>${fileType.toUpperCase()}: تم دمج البيانات لـ ${Object.keys(officeAggregation).length} مكتب</strong></p>`;
        }

        function loadOfficeDetails() {
            debugContent.innerHTML += '<p><strong>تحميل تفاصيل المكاتب...</strong></p>';
            
            const possibleSheetNames = [
                'office_details',
                'Office_Details', 
                'OFFICE_DETAILS',
                'Office Details',
                'OFFICE DETAILS',
                'Sheet1',
                'Sheet 1'
            ];
            
            let officeSheetName = null;
            for (const name of possibleSheetNames) {
                if (consolidatedWorkbook.Sheets[name]) {
                    officeSheetName = name;
                    break;
                }
            }
            
            if (!officeSheetName && consolidatedWorkbook.SheetNames.length > 0) {
                officeSheetName = consolidatedWorkbook.SheetNames[0];
            }

            debugContent.innerHTML += `<p>الأوراق المتاحة: ${consolidatedWorkbook.SheetNames.join(', ')}</p>`;
            debugContent.innerHTML += `<p>استخدام الورقة: ${officeSheetName}</p>`;

            if (officeSheetName && consolidatedWorkbook.Sheets[officeSheetName]) {
                const officeSheet = consolidatedWorkbook.Sheets[officeSheetName];
                const officeData = XLSX.utils.sheet_to_json(officeSheet);
                
                debugContent.innerHTML += `<p>تم العثور على ${officeData.length} صف في ورقة المكاتب</p>`;
                
                if (officeData.length > 0) {
                    debugContent.innerHTML += `<p>أعمدة الصف الأول: ${Object.keys(officeData[0]).join(', ')}</p>`;
                }
                
                officeData.forEach((row, index) => {
                    const officeId = row['OFFICE ID'] || row['Office ID'] || row['office_id'] || 
                                   row['OfficeID'] || row['Office Id'] || row['OFFICEID'] ||
                                   row['Office_ID'] || row['ID'] || '';
                    
                    const officeName = row['OFFICE NAME'] || row['Office Name'] || row['office_name'] ||
                                     row['OfficeName'] || row['Office_Name'] || row['OFFICENAME'] ||
                                     row['Name'] || row['NAME'] || '';
                    
                    const officeArabicName = row['OFFICE ARABIC NAME'] || row['Office Arabic Name'] || 
                                           row['office_arabic_name'] || row['ArabicName'] || 
                                           row['Arabic_Name'] || row['ARABICNAME'] ||
                                           row['Arabic Name'] || row['ARABIC NAME'] || '';
                    
                    const iataNumber = row['IATA NUMBER'] || row['Iata Number'] || row['iata_number'] ||
                                     row['IATA_NUMBER'] || row['IataNumber'] || row['IATANUMBER'] ||
                                     row['IATA'] || row['Iata'] || '';
                    
                    if (officeId) {
                        const cleanOfficeId = officeId.toString().trim();
                        officeDetails[cleanOfficeId] = {
                            name: officeName ? officeName.toString().trim() : 'مكتب غير معروف',
                            arabicName: officeArabicName ? officeArabicName.toString().trim() : 'مكتب غير معروف',
                            iataNumber: iataNumber ? iataNumber.toString().trim() : 'غير معروف'
                        };
                        
                        if (index < 5) {
                            debugContent.innerHTML += `<p>عينة مكتب: ${cleanOfficeId} -> ${officeName} | ${officeArabicName} | ${iataNumber}</p>`;
                        }
                    }
                });
                
                debugContent.innerHTML += `<p>تم ربط ${Object.keys(officeDetails).length} مكتب بنجاح</p>`;
            } else {
                debugContent.innerHTML += '<p><strong>تحذير:</strong> لم يتم العثور على ورقة تفاصيل المكاتب</p>';
            }
        }

        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        function createMasterSummary() {
            debugContent.innerHTML += '<p><strong>إنشاء الملخص الرئيسي...</strong></p>';

            // Convert master summary to array and calculate totals (only offices with data)
            const summaryArray = Object.values(masterSummary)
                .filter(office => {
                    const hasTransactions = office.atcCount > 0 || office.wepCount > 0 || office.pnrCount > 0 || 
                                          office.mptCount > 0 || office.mpeCount > 0 ||
                                          office.atcCost > 0 || office.wepCost > 0 || office.pnrCost > 0 || 
                                          office.mptCost > 0 || office.mpeCost > 0;
                    return hasTransactions;
                })
                .map(office => ({
                    'Office ID': office.officeId,
                    'Office Name': office.officeName,
                    'Office Arabic Name': office.officeArabicName,
                    'IATA Number': office.iataNumber,
                    'ATC Count': office.atcCount,
                    'ATC Cost': office.atcCost,
                    'ATC Months': Array.from(office.atcMonths || []).sort().join(','),
                    'WEP Count': office.wepCount,
                    'WEP Cost': office.wepCost,
                    'WEP Months': Array.from(office.wepMonths || []).sort().join(','),
                    'PNR Count': office.pnrCount,
                    'PNR Cost': office.pnrCost,
                    'PNR Months': Array.from(office.pnrMonths || []).sort().join(','),
                    'MPT Count': office.mptCount,
                    'MPT Cost': office.mptCost,
                    'MPT Months': Array.from(office.mptMonths || []).sort().join(','),
                    'MPE Count': office.mpeCount,
                    'MPE Cost': office.mpeCost,
                    'MPE Months': Array.from(office.mpeMonths || []).sort().join(','),
                    'Total Cost': office.atcCost + office.wepCost + office.pnrCost + office.mptCost + office.mpeCost,
                    'Total Count': office.atcCount + office.wepCount + office.pnrCount + office.mptCount + office.mpeCount
                }));

            debugContent.innerHTML += `<p>الملخص الرئيسي: ${summaryArray.length} مكتب مع معاملات</p>`;

            // Sort by Total Cost (highest first), then by Office ID
            summaryArray.sort((a, b) => {
                if (b['Total Cost'] !== a['Total Cost']) {
                    return b['Total Cost'] - a['Total Cost'];
                }
                return a['Office ID'].localeCompare(b['Office ID']);
            });

            // Create worksheet
            const masterSheet = XLSX.utils.json_to_sheet(summaryArray);
            
            // Add to workbook
            consolidatedWorkbook.Sheets['Master_Summary_With_Months'] = masterSheet;
            consolidatedWorkbook.SheetNames.unshift('Master_Summary_With_Months');
        }

        function displayResults() {
            // Only show offices that have transactions
            const summaryArray = Object.values(masterSummary)
                .filter(office => {
                    const hasTransactions = office.atcCount > 0 || office.wepCount > 0 || office.pnrCount > 0 || 
                                          office.mptCount > 0 || office.mpeCount > 0 ||
                                          office.atcCost > 0 || office.wepCost > 0 || office.pnrCost > 0 || 
                                          office.mptCost > 0 || office.mpeCost > 0;
                    return hasTransactions;
                })
                .map(office => ({
                    officeId: office.officeId,
                    officeName: office.officeName,
                    officeArabicName: office.officeArabicName,
                    iataNumber: office.iataNumber,
                    atcCount: office.atcCount,
                    atcCost: office.atcCost,
                    atcMonths: office.atcMonths || new Set(),
                    wepCount: office.wepCount,
                    wepCost: office.wepCost,
                    wepMonths: office.wepMonths || new Set(),
                    pnrCount: office.pnrCount,
                    pnrCost: office.pnrCost,
                    pnrMonths: office.pnrMonths || new Set(),
                    mptCount: office.mptCount,
                    mptCost: office.mptCost,
                    mptMonths: office.mptMonths || new Set(),
                    mpeCount: office.mpeCount,
                    mpeCost: office.mpeCost,
                    mpeMonths: office.mpeMonths || new Set(),
                    totalCost: office.atcCost + office.wepCost + office.pnrCost + office.mptCost + office.mpeCost,
                    totalCount: office.atcCount + office.wepCount + office.pnrCount + office.mptCount + office.mpeCount
                }));

            // Sort by Total Cost (highest first), then by Office ID
            summaryArray.sort((a, b) => {
                if (b.totalCost !== a.totalCost) {
                    return b.totalCost - a.totalCost;
                }
                return a.officeId.localeCompare(b.officeId);
            });

            summaryTableBody.innerHTML = summaryArray.map(office => `
                <tr>
                    <td><span class="office-id">${office.officeId}</span></td>
                    <td>${office.officeName}</td>
                    <td>${office.officeArabicName}</td>
                    <td>${office.iataNumber}</td>
                    <td class="count-cell">${office.atcCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.atcCost.toFixed(3)}</td>
                    <td class="count-cell">${office.wepCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.wepCost.toFixed(3)}</td>
                    <td class="count-cell">${office.pnrCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.pnrCost.toFixed(3)}</td>
                    <td class="count-cell">${office.mptCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.mptCost.toFixed(3)}</td>
                    <td class="count-cell">${office.mpeCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.mpeCost.toFixed(3)}</td>
                    <td class="total-cell">${office.totalCost.toFixed(3)}</td>
                </tr>
            `).join('');
        }

        // Download consolidated file
        downloadBtn.addEventListener('click', () => {
            if (!consolidatedWorkbook) {
                alert('لا توجد بيانات للتحميل. يرجى معالجة الملفات أولاً.');
                return;
            }

            XLSX.writeFile(consolidatedWorkbook, 'bills_consolidated_with_months.xlsx');
        });

        // Helper function to format month ranges
        function formatMonthRange(monthsSet) {
            if (!monthsSet || monthsSet.size === 0) return '';
            
            const months = Array.from(monthsSet).sort((a, b) => a - b);
            if (months.length === 1) {
                return ` للشهر ${months[0]}`;
            } else if (months.length === 2 && months[1] === months[0] + 1) {
                return ` للشهرين ${months[0]},${months[1]}`;
            } else {
                return ` للاشهر ${months.join(',')}`;
            }
        }

        // Generate individual office invoices with month information
        generateInvoicesBtn.addEventListener('click', () => {
            if (!consolidatedWorkbook || !masterSummary) {
                alert('لا توجد بيانات متاحة. يرجى معالجة الملفات أولاً.');
                return;
            }

            generateOfficeInvoicesWithMonths();
        });

        // Function to convert number to Arabic words
        function numberToArabic(num) {
            const ones = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
            const tens = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const teens = ['عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
            const hundreds = ['', 'مائة', 'مئتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];

            if (num === 0) return 'صفر';
            if (num < 0) return 'سالب ' + numberToArabic(-num);

            let result = '';

            // Handle thousands
            if (num >= 1000) {
                const thousands = Math.floor(num / 1000);
                if (thousands === 1) {
                    result += 'ألف ';
                } else if (thousands === 2) {
                    result += 'ألفان ';
                } else if (thousands <= 10) {
                    result += ones[thousands] + ' آلاف ';
                } else {
                    result += numberToArabic(thousands) + ' ألف ';
                }
                num %= 1000;
            }

            // Handle hundreds
            if (num >= 100) {
                result += hundreds[Math.floor(num / 100)] + ' ';
                num %= 100;
            }

            // Handle tens and ones - ones come before tens in Arabic
            if (num >= 20) {
                const onesDigit = num % 10;
                const tensDigit = Math.floor(num / 10);
                
                if (onesDigit !== 0) {
                    result += ones[onesDigit] + ' و' + tens[tensDigit];
                } else {
                    result += tens[tensDigit];
                }
            } else if (num >= 10) {
                result += teens[num - 10];
            } else if (num > 0) {
                result += ones[num];
            }

            return result.trim();
        }

        function getCurrentDateArabic() {
            const date = new Date();
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            
            const months = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];
            
            return `${day} ${months[month - 1]} ${year}`;
        }

        function generateOfficeInvoicesWithMonths() {
            try {
                progressDiv.style.display = 'block';
                progressText.textContent = 'جاري إنشاء فواتير المكاتب الفردية مع معلومات الأشهر...';
                
                const invoiceWorkbook = XLSX.utils.book_new();
                
                const officesWithTransactions = Object.values(masterSummary)
                    .filter(office => {
                        const hasTransactions = office.atcCount > 0 || office.wepCount > 0 || office.pnrCount > 0 || 
                                              office.mptCount > 0 || office.mpeCount > 0 ||
                                              office.atcCost > 0 || office.wepCost > 0 || office.pnrCost > 0 || 
                                              office.mptCost > 0 || office.mpeCost > 0;
                        return hasTransactions;
                    })
                    .sort((a, b) => a.officeId.localeCompare(b.officeId));

                debugContent.innerHTML += `<p>إنشاء فواتير لـ ${officesWithTransactions.length} مكتب مع معلومات الأشهر...</p>`;

                // Create invoice sheet for each office
                officesWithTransactions.forEach((office, index) => {
                    progressText.textContent = `إنشاء فاتورة للمكتب ${office.officeId} (${index + 1}/${officesWithTransactions.length})...`;
                    
                    const currentDate = getCurrentDateArabic();
                    const currentYear = new Date().getFullYear();
                    
                    let subtotal = 0;
                    let rowCounter = 1;
                    const serviceRows = [];

                    // Add service lines with month information (only for services with non-zero values)
                    if (office.mpeCost > 0) {
                        const monthRange = formatMonthRange(office.mpeMonths);
                        serviceRows.push([
                            rowCounter++, 
                            `استخدام خاصية عرض أفضل الأسعار لرحلة معينة MPE${monthRange}`, 
                            office.mpeCount, 
                            office.mpeCost.toFixed(3)
                        ]);
                        subtotal += office.mpeCost;
                    }
                    
                    if (office.mptCost > 0) {
                        const monthRange = formatMonthRange(office.mptMonths);
                        serviceRows.push([
                            rowCounter++, 
                            `استخدام خاصية عرض أفضل الأسعار لرحلة معينة MPT${monthRange}`, 
                            office.mptCount, 
                            office.mptCost.toFixed(3)
                        ]);
                        subtotal += office.mptCost;
                    }

                    if (office.atcCost > 0) {
                        const monthRange = formatMonthRange(office.atcMonths);
                        serviceRows.push([
                            rowCounter++, 
                            `استخدام خاصية تغيير التذاكر ATC${monthRange}`, 
                            office.atcCount, 
                            office.atcCost.toFixed(3)
                        ]);
                        subtotal += office.atcCost;
                    }

                    if (office.wepCost > 0) {
                        const monthRange = formatMonthRange(office.wepMonths);
                        serviceRows.push([
                            rowCounter++, 
                            `استخدام الخدمات الإلكترونية WEP${monthRange}`, 
                            office.wepCount, 
                            office.wepCost.toFixed(3)
                        ]);
                        subtotal += office.wepCost;
                    }

                    if (office.pnrCost > 0) {
                        const monthRange = formatMonthRange(office.pnrMonths);
                        serviceRows.push([
                            rowCounter++, 
                            `استخدام خاصية استدعاء الحجوزات PNR${monthRange}`, 
                            office.pnrCount, 
                            office.pnrCost.toFixed(3)
                        ]);
                        subtotal += office.pnrCost;
                    }

                    const totalCost = subtotal;
                    const totalInWords = numberToArabic(Math.floor(totalCost)) + ' دينار ليبي';

                    // Create Arabic invoice data with RTL layout
                    const invoiceData = [
                        ['', '', '', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', '', 'شركة أماديوس ليبيا للخدمات التقنية المشتركة', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', `التاريخ: ${currentDate}`, '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', '', '', `الاخوة / ${office.officeArabicName}`, ''],
                        ['', '', '', '', '', ''],
                        ['', '', `رقم الآياتا: ${office.iataNumber}`, '', 'بعد التحية ،،،', ''],
                        ['', '', '', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '',`فاتورة رقم: _____ / ${currentYear}`, '', '',''],
                        ['', '', '', '', '', ''],
                        ['', '', '', 'نأمل منكم سداد قيمة الفاتورة المبينة أدناه :', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', 'القيمة (د.ل)' , 'الكمية','البيان','ر.ت',''],

                        ['', '', '', '', '', '']
                    ];

                     serviceRows.forEach(row => {
                        invoiceData.push([
                            '',  row[3],  // القيمة,
                            row[2], // الكمية
                            row[1], // البيان (with month info)
                            row[0], // ر.ت
                            ''  
                        ]);
                    });

                    // Add totals and footer
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', subtotal.toFixed(3), '', 'الاجمالي', '','']);

                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', `المبلغ بالحروف: ${totalInWords}`, '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', 'طريقة السداد:', '', '']);
                    invoiceData.push(['', '', '', 'يكون السداد نقداً أو بصك مصدق بخزينة الشركة', '', '']);
                    invoiceData.push(['', '', '', 'بإسم شركة أمادييوس ليبيا للخدمات التقنية المشتركة', '', '']);
                    invoiceData.push(['', '', '', 'أو بإيداع المبلغ بحساب الشركة رقم 0900003088', '', '']);
                   invoiceData.push(['', '', '', 'لدى المصرف الليبي الخارجي.', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', 'والســـــــــــــــــــ عليكم ــــــــــــــــــلام', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', '.........................', '', '']);
                    invoiceData.push(['', '', '', 'مدير الشؤون الادارية و المالية', '', '']);

                    // Create worksheet
                    const invoiceSheet = XLSX.utils.aoa_to_sheet(invoiceData);
                    
                    if (!invoiceSheet['!ref']) invoiceSheet['!ref'] = 'A1:F35';
                    
                    // Set column widths for RTL layout - INCREASED WIDTHS
                    invoiceSheet['!cols'] = [
                        { width: 20 }, // Empty space column 1
                        { width: 20 }, // Empty space column 2
                        { width: 20 }, // ر.ت column
                        { width: 80 }, // البيان column - service description (increased for month info)
                        { width: 35 }, // الكمية column - quantity
                        { width: 20 }  // القيمة column - cost
                    ];
                    
                    // Set RTL text alignment
                    const range = XLSX.utils.decode_range(invoiceSheet['!ref']);
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!invoiceSheet[cellAddress]) continue;
                            
                            if (!invoiceSheet[cellAddress].s) invoiceSheet[cellAddress].s = {};
                            invoiceSheet[cellAddress].s.alignment = {
                                horizontal: 'right',
                                vertical: 'center',
                                readingOrder: 2
                            };
                        }
                    }

                    // Create clean sheet name
                    const cleanOfficeId = office.officeId.replace(/[^\w\s]/gi, '').substring(0, 31);
                    const sheetName = `فاتورة_${cleanOfficeId}`;
                    
                    XLSX.utils.book_append_sheet(invoiceWorkbook, invoiceSheet, sheetName);
                });

                // Create summary sheet with month information
                const allInvoicesData = [
                    ['', 'ملخص فواتير جميع المكاتب مع الأشهر - AMADEUS SERVICES WITH MONTHS', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', ''],
                    ['رمز المكتب', 'اسم المكتب', 'الاسم العربي', 'رقم الآياتا', 'إجمالي العدد', 'المبلغ الإجمالي', 'أشهر الخدمات', 'الحالة'],
                    ['', '', '', '', '', '', '', '']
                ];

                officesWithTransactions.forEach(office => {
                    const totalCost = office.atcCost + office.wepCost + office.pnrCost + office.mptCost + office.mpeCost;
                    const totalCount = office.atcCount + office.wepCount + office.pnrCount + office.mptCount + office.mpeCount;
                    
                    // Collect all months from all services
                    const allMonths = new Set();
                    if (office.atcMonths) office.atcMonths.forEach(m => allMonths.add(m));
                    if (office.wepMonths) office.wepMonths.forEach(m => allMonths.add(m));
                    if (office.pnrMonths) office.pnrMonths.forEach(m => allMonths.add(m));
                    if (office.mptMonths) office.mptMonths.forEach(m => allMonths.add(m));
                    if (office.mpeMonths) office.mpeMonths.forEach(m => allMonths.add(m));
                    
                    const monthsText = Array.from(allMonths).sort().join(',') || 'غير محدد';
                    
                    allInvoicesData.push([
                        office.officeId,
                        office.officeName,
                        office.officeArabicName,
                        office.iataNumber,
                        totalCount.toLocaleString(),
                        totalCost.toFixed(3),
                        monthsText,
                        'تم إنشاء الفاتورة مع معلومات الأشهر'
                    ]);
                });

                const summarySheet = XLSX.utils.aoa_to_sheet(allInvoicesData);
                summarySheet['!cols'] = [
                    { width: 15 }, { width: 25 }, { width: 25 }, { width: 15 },
                    { width: 15 }, { width: 15 }, { width: 20 }, { width: 30 }
                ];

                XLSX.utils.book_append_sheet(invoiceWorkbook, summarySheet, 'ملخص_الفواتير_مع_الأشهر');
                
                // Move summary to first position
                const sheetNames = invoiceWorkbook.SheetNames;
                const summaryIndex = sheetNames.indexOf('ملخص_الفواتير_مع_الأشهر');
                if (summaryIndex > 0) {
                    sheetNames.splice(summaryIndex, 1);
                    sheetNames.unshift('ملخص_الفواتير_مع_الأشهر');
                }

                progressText.textContent = 'تحميل ملف الفواتير مع معلومات الأشهر...';
                XLSX.writeFile(invoiceWorkbook, 'فواتير_أماديوس_مع_الأشهر.xlsx');
                
                debugContent.innerHTML += `<p><strong>نجح!</strong> تم إنشاء ${officesWithTransactions.length} فاتورة مع معلومات الأشهر</p>`;
                alert(`تم إنشاء ${officesWithTransactions.length} فاتورة بنجاح مع معلومات الأشهر!\nتم تحميل الملف باسم: فواتير_أماديوس_مع_الأشهر.xlsx`);
                
            } catch (error) {
                console.error('Error generating invoices:', error);
                alert('خطأ في إنشاء الفواتير: ' + error.message);
                debugContent.innerHTML += `<p><strong>خطأ في إنشاء الفواتير:</strong> ${error.message}</p>`;
            } finally {
                progressDiv.style.display = 'none';
            }
        }

        // Initialize display
        Object.keys(fileCollections).forEach(type => {
            updateFileDisplay(type);
        });

        console.log('Enhanced Multi-File Consolidator with Months loaded successfully!');
    </script>
</body>
</html>
