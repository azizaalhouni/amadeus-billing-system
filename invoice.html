<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Files Consolidator</title>
    <style>
        body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            direction: rtl;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .description {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
        }

        .upload-section {
            margin: 2rem 0;
            padding: 2rem;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .file-group {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }

        .file-group h3 {
            margin-top: 0;
            color: #007cba;
        }

        .file-input {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            direction: ltr;
        }

        .file-status {
            margin-right: 1rem;
            font-size: 0.9rem;
        }

        .status-success {
            color: #28a745;
        }

        .status-pending {
            color: #6c757d;
        }

        .process-btn, .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 0.5rem;
            transition: background-color 0.2s;
        }

        .process-btn:hover:not(:disabled) {
            background: #218838;
        }

        .process-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .download-btn {
            background: #007cba;
        }

        .download-btn:hover {
            background: #005a87;
        }

        .results-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #28a745;
        }

        .results-section h3 {
            color: #28a745;
            margin-top: 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            direction: rtl;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9rem;
            direction: rtl;
        }

        th, td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        .office-id {
            background: #e7f3ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-family: monospace;
        }

        .count-cell {
            text-align: left;
            font-weight: bold;
        }

        .cost-cell {
            text-align: left;
            font-weight: bold;
            color: #dc3545;
        }

        .total-cell {
            background: #d4edda;
            font-weight: bold;
            text-align: left;
        }

        .progress {
            margin: 1rem 0;
            padding: 1rem;
            background: #e7f3ff;
            border-radius: 6px;
            display: none;
        }

        .debug-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }

        .invoice-table {
            direction: rtl;
        }

        .invoice-table th,
        .invoice-table td {
            text-align: right;
        }

        .invoice-table .number-cell {
            text-align: left;
        }

        /* Enhanced styling for dual columns */
        .dual-header {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .count-header {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .cost-header {
            background: #ffebee;
            border-left: 3px solid #f44336;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav style="
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
padding: 1rem 0;
margin: -2rem -2rem 2rem -2rem;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
">
<div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
    <h2 style="color: white; margin: 0 0 1rem 0; text-align: center; font-size: 1.5rem;">
       Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ù…Ø§Ø¯ÙŠÙˆØ³
    </h2>
    <h2 style="color: white; margin: 0 0 1rem 0; text-align: center; font-size: 1.5rem;">
       Amadeus Reports Processing Suite
    </h2>
    <div class="nav-links" style="
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        align-items: center;
        direction: ltr;
    ">
        <a href="ATC&MPT.html" style="
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
           ATC & MPT Reports
        </a>
        <a href="wep.html" style="
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
           WEP Reports
        </a>
        <a href="pnr.html" style="
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
           PNR Reports
        </a>
        <a href="mpe.html" style="
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
             MPE Reports
        </a>
        <a href="invoice.html" style="
            background: rgba(255,255,255,0.4);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.6);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        " onmouseover="this.style.background='rgba(255,255,255,0.5)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.4)'">
           Ø§Ù„Ù…ÙˆØ­Ø¯ Consolidator
        </a>
    </div>
    <p style="
        color: rgba(255,255,255,0.9);
        text-align: center;
        margin: 1rem 0 0 0;
        font-size: 0.85rem;
    ">
        Ù‚Ù… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙØ±Ø¯ÙŠØ©ØŒ Ø«Ù… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ù…Ø®Ø±Ø¬Ø§Øª Excel
    </p>
    <p style="
        color: rgba(255,255,255,0.9);
        text-align: center;
        margin: 1rem 0 0 0;
        font-size: 0.85rem;
    ">
        Process individual reports, then use the Consolidator to merge all Excel outputs
    </p>
</div>
</nav>
    <div class="container">
        <h1>Ù…ÙˆØ­Ø¯ Ù…Ù„ÙØ§Øª Excel ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h1>
        <h1>Excel Files Consolidator & Generate Invoices</h1>

        <p class="description">Ø¯Ù…Ø¬ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø§ÙƒØ³Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© ÙÙŠ bills.xlsx ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„ÙƒÙ…ÙŠØ©</p>
        <p class="description">Consolidate Summary sheets from multiple Amadeus Excel files into bills.xlsx and Generate Bills with Cost & Count columns</p>
        
        <div class="upload-section">
            <div class="file-group">
                <h3>ğŸ“Š Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (bills.xlsx) - Master File</h3>
                <input type="file" id="billsFile" class="file-input" accept=".xlsx,.xls" />
                <span id="billsStatus" class="file-status status-pending">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>
            </div>

            <div class="file-group">
                <h3>ğŸ« Ù…Ù„Ù ATC (atc_amadeus_summary_and_details2.xlsx)</h3>
                <input type="file" id="atcFile" class="file-input" accept=".xlsx,.xls" />
                <span id="atcStatus" class="file-status status-pending">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>
            </div>

            <div class="file-group">
                <h3>ğŸŒ Ù…Ù„Ù WEP (amadeus_WEP_summary.xlsx)</h3>
                <input type="file" id="wepFile" class="file-input" accept=".xlsx,.xls" />
                <span id="wepStatus" class="file-status status-pending">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>
            </div>

            <div class="file-group">
                <h3>ğŸ“‹ Ù…Ù„Ù PNR (amadeus_PNR_summary.xlsx)</h3>
                <input type="file" id="pnrFile" class="file-input" accept=".xlsx,.xls" />
                <span id="pnrStatus" class="file-status status-pending">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>
            </div>

            <div class="file-group">
                <h3>ğŸ“ˆ Ù…Ù„Ù MPT</h3>
                <input type="file" id="mptFile" class="file-input" accept=".xlsx,.xls" />
                <span id="mptStatus" class="file-status status-pending">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>
            </div>

            <div class="file-group">
                <h3>ğŸ” Ù…Ù„Ù MPE</h3>
                <input type="file" id="mpeFile" class="file-input" accept=".xlsx,.xls" />
                <span id="mpeStatus" class="file-status status-pending">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</span>
            </div>

            <div class="progress" id="progressDiv">
                <p id="progressText">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª...</p>
            </div>

            <div class="debug-info" id="debugInfo">
                <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­:</h4>
                <div id="debugContent"></div>
            </div>

            <button id="processBtn" class="process-btn" disabled>
                Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¯Ù…Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª - Process & Consolidate Files
            </button>
        </div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <h3>ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù…Ø¹ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„ÙƒÙ…ÙŠØ© - Enhanced Consolidated Summary Preview</h3>
            <div class="table-container">
                <table id="summaryTable" class="invoice-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù…Ø² Ø§Ù„Ù…ÙƒØªØ¨</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨</th>
                            <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th>
                            <th>Ø±Ù‚Ù… IATA</th>
                            <th class="count-header">Ø¹Ø¯Ø¯ ATC</th>
                            <th class="cost-header">ØªÙƒÙ„ÙØ© ATC</th>
                            <th class="count-header">Ø¹Ø¯Ø¯ WEP</th>
                            <th class="cost-header">ØªÙƒÙ„ÙØ© WEP</th>
                            <th class="count-header">Ø¹Ø¯Ø¯ PNR</th>
                            <th class="cost-header">ØªÙƒÙ„ÙØ© PNR</th>
                            <th class="count-header">Ø¹Ø¯Ø¯ MPT</th>
                            <th class="cost-header">ØªÙƒÙ„ÙØ© MPT</th>
                            <th class="count-header">Ø¹Ø¯Ø¯ MPE</th>
                            <th class="cost-header">ØªÙƒÙ„ÙØ© MPE</th>
                            <th class="total-cell">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody">
                    </tbody>
                </table>
            </div>

            <button id="downloadBtn" class="download-btn">
                ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ - Download Consolidated bills.xlsx
            </button>
            
            <button id="generateInvoicesBtn" class="download-btn" style="background: #dc3545; margin-right: 10px;">
                Ø¥Ù†Ø´Ø§Ø¡ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„ÙØ±Ø¯ÙŠØ© - Generate Individual Office Invoices
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let files = {};
        let consolidatedWorkbook = null;
        let masterSummary = {};
        let officeDetails = {};

        // DOM elements
        const fileInputs = {
            bills: document.getElementById('billsFile'),
            atc: document.getElementById('atcFile'),
            wep: document.getElementById('wepFile'),
            pnr: document.getElementById('pnrFile'),
            mpt: document.getElementById('mptFile'),
            mpe: document.getElementById('mpeFile')
        };

        const statusElements = {
            bills: document.getElementById('billsStatus'),
            atc: document.getElementById('atcStatus'),
            wep: document.getElementById('wepStatus'),
            pnr: document.getElementById('pnrStatus'),
            mpt: document.getElementById('mptStatus'),
            mpe: document.getElementById('mpeStatus')
        };

        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const generateInvoicesBtn = document.getElementById('generateInvoicesBtn');
        const progressDiv = document.getElementById('progressDiv');
        const progressText = document.getElementById('progressText');
        const resultsSection = document.getElementById('resultsSection');
        const summaryTableBody = document.getElementById('summaryTableBody');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');

        // Handle file uploads
        Object.keys(fileInputs).forEach(key => {
            fileInputs[key].addEventListener('change', (event) => {
                handleFileUpload(key, event.target.files[0]);
            });
        });

        function handleFileUpload(type, file) {
            if (!file) return;

            files[type] = file;
            statusElements[type].textContent = `âœ… ${file.name}`;
            statusElements[type].className = 'file-status status-success';

            const hasBills = files.bills;
            const hasDataFiles = files.atc || files.wep || files.pnr || files.mpt || files.mpe;
            
            processBtn.disabled = !(hasBills && hasDataFiles);
        }

        // Process files
        processBtn.addEventListener('click', async () => {
            progressDiv.style.display = 'block';
            debugInfo.style.display = 'block';
            processBtn.disabled = true;
            
            try {
                await processFiles();
                displayResults();
                resultsSection.style.display = 'block';
            } catch (error) {
                console.error('Error processing files:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª: ' + error.message);
                debugContent.innerHTML += `<p><strong>Ø®Ø·Ø£:</strong> ${error.message}</p>`;
            } finally {
                progressDiv.style.display = 'none';
                processBtn.disabled = false;
            }
        });

        async function processFiles() {
            // Read bills.xlsx
            progressText.textContent = 'Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù bills.xlsx...';
            const billsData = await readFile(files.bills);
            consolidatedWorkbook = XLSX.read(billsData);

            // Load office details from bills.xlsx
            progressText.textContent = 'ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨...';
            loadOfficeDetails();

            // Process each data file
            const dataFiles = ['atc', 'wep', 'pnr', 'mpt', 'mpe'];
            
            for (const fileType of dataFiles) {
                if (files[fileType]) {
                    progressText.textContent = `Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù ${fileType.toUpperCase()}...`;
                    await processDataFile(fileType, files[fileType]);
                }
            }

            // Create master summary sheet
            progressText.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...';
            createMasterSummary();
        }

        function loadOfficeDetails() {
            debugContent.innerHTML += '<p><strong>ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨...</strong></p>';
            
            const possibleSheetNames = [
                'office_details',
                'Office_Details', 
                'OFFICE_DETAILS',
                'Office Details',
                'OFFICE DETAILS',
                'Sheet1',
                'Sheet 1'
            ];
            
            let officeSheetName = null;
            for (const name of possibleSheetNames) {
                if (consolidatedWorkbook.Sheets[name]) {
                    officeSheetName = name;
                    break;
                }
            }
            
            if (!officeSheetName && consolidatedWorkbook.SheetNames.length > 0) {
                officeSheetName = consolidatedWorkbook.SheetNames[0];
            }

            debugContent.innerHTML += `<p>Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ§Ø­Ø©: ${consolidatedWorkbook.SheetNames.join(', ')}</p>`;
            debugContent.innerHTML += `<p>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ±Ù‚Ø©: ${officeSheetName}</p>`;

            if (officeSheetName && consolidatedWorkbook.Sheets[officeSheetName]) {
                const officeSheet = consolidatedWorkbook.Sheets[officeSheetName];
                const officeData = XLSX.utils.sheet_to_json(officeSheet);
                
                debugContent.innerHTML += `<p>ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${officeData.length} ØµÙ ÙÙŠ ÙˆØ±Ù‚Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨</p>`;
                
                if (officeData.length > 0) {
                    debugContent.innerHTML += `<p>Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: ${Object.keys(officeData[0]).join(', ')}</p>`;
                }
                
                officeData.forEach((row, index) => {
                    const officeId = row['OFFICE ID'] || row['Office ID'] || row['office_id'] || 
                                   row['OfficeID'] || row['Office Id'] || row['OFFICEID'] ||
                                   row['Office_ID'] || row['ID'] || '';
                    
                    const officeName = row['OFFICE NAME'] || row['Office Name'] || row['office_name'] ||
                                     row['OfficeName'] || row['Office_Name'] || row['OFFICENAME'] ||
                                     row['Name'] || row['NAME'] || '';
                    
                    const officeArabicName = row['OFFICE ARABIC NAME'] || row['Office Arabic Name'] || 
                                           row['office_arabic_name'] || row['ArabicName'] || 
                                           row['Arabic_Name'] || row['ARABICNAME'] ||
                                           row['Arabic Name'] || row['ARABIC NAME'] || '';
                    
                    const iataNumber = row['IATA NUMBER'] || row['Iata Number'] || row['iata_number'] ||
                                     row['IATA_NUMBER'] || row['IataNumber'] || row['IATANUMBER'] ||
                                     row['IATA'] || row['Iata'] || '';
                    
                    if (officeId) {
                        const cleanOfficeId = officeId.toString().trim();
                        officeDetails[cleanOfficeId] = {
                            name: officeName ? officeName.toString().trim() : 'Ù…ÙƒØªØ¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                            arabicName: officeArabicName ? officeArabicName.toString().trim() : 'Ù…ÙƒØªØ¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                            iataNumber: iataNumber ? iataNumber.toString().trim() : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                        };
                        
                        if (index < 5) {
                            debugContent.innerHTML += `<p>Ø¹ÙŠÙ†Ø© Ù…ÙƒØªØ¨: ${cleanOfficeId} -> ${officeName} | ${officeArabicName} | ${iataNumber}</p>`;
                        }
                    }
                });
                
                debugContent.innerHTML += `<p>ØªÙ… Ø±Ø¨Ø· ${Object.keys(officeDetails).length} Ù…ÙƒØªØ¨ Ø¨Ù†Ø¬Ø§Ø­</p>`;
            } else {
                debugContent.innerHTML += '<p><strong>ØªØ­Ø°ÙŠØ±:</strong> Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ±Ù‚Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒØ§ØªØ¨</p>';
            }
        }

        async function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        async function processDataFile(fileType, file) {
            const data = await readFile(file);
            const workbook = XLSX.read(data);
            
            debugContent.innerHTML += `<p>Ù…Ø¹Ø§Ù„Ø¬Ø© ${fileType}: Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…ØªØ§Ø­Ø©: ${workbook.SheetNames.join(', ')}</p>`;
            
            const possibleSummaryNames = [
                'Summary by Office ID',
                'Summary with Costs',
                'Summary',
                'summary',
                'SUMMARY',
                'Sheet1'
            ];
            
            let summarySheetName = null;
            for (const name of possibleSummaryNames) {
                if (workbook.SheetNames.includes(name)) {
                    summarySheetName = name;
                    break;
                }
            }
            
            if (!summarySheetName) {
                summarySheetName = workbook.SheetNames[0];
            }

            debugContent.innerHTML += `<p>${fileType}: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ±Ù‚Ø© '${summarySheetName}'</p>`;

            if (!summarySheetName) {
                debugContent.innerHTML += `<p><strong>ØªØ­Ø°ÙŠØ±:</strong> Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ù„Ø®Øµ ÙÙŠ Ù…Ù„Ù ${fileType}</p>`;
                return;
            }

            const summarySheet = workbook.Sheets[summarySheetName];
            const summaryData = XLSX.utils.sheet_to_json(summarySheet);

            debugContent.innerHTML += `<p>${fileType}: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${summaryData.length} ØµÙ</p>`;
            
            if (summaryData.length > 0) {
                debugContent.innerHTML += `<p>${fileType}: Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${Object.keys(summaryData[0]).join(', ')}</p>`;
            }

            const newSheetName = `${fileType.toUpperCase()}_Summary`;
            consolidatedWorkbook.Sheets[newSheetName] = summarySheet;
            consolidatedWorkbook.SheetNames.push(newSheetName);

            summaryData.forEach((row, index) => {
                const officeId = row['Office ID'] || row['Office Id'] || row['OFFICE ID'] || 
                               row['OfficeID'] || row['ID'] || '';
                
                // Get count (quantity)
                const totalCount = parseFloat(
                    row['Total Transactions'] || row['Total Count'] || row['Count'] ||
                    row['Total PNR Recalls'] || row['Total Searches'] || row['Number of Transactions'] ||
                    row['TOTAL COUNT'] || row['Transaction Count'] || 0
                );
                
                // Get cost
                const totalCost = parseFloat(
                    row['Total Cost'] || row['Cost'] || row['Total Amount'] ||
                    row['Grand Total'] || row['TOTAL COST'] || row['Amount'] || 0
                );

                if (officeId && (!isNaN(totalCount) || !isNaN(totalCost))) {
                    const cleanOfficeId = officeId.toString().trim();
                    
                    if (!masterSummary[cleanOfficeId]) {
                        const officeInfo = officeDetails[cleanOfficeId] || {
                            name: 'Ù…ÙƒØªØ¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                            arabicName: 'Ù…ÙƒØªØ¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                            iataNumber: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                        };
                        
                        masterSummary[cleanOfficeId] = {
                            officeId: cleanOfficeId,
                            officeName: officeInfo.name,
                            officeArabicName: officeInfo.arabicName,
                            iataNumber: officeInfo.iataNumber,
                            atcCount: 0,
                            atcCost: 0,
                            wepCount: 0,
                            wepCost: 0,
                            pnrCount: 0,
                            pnrCost: 0,
                            mptCount: 0,
                            mptCost: 0,
                            mpeCount: 0,
                            mpeCost: 0
                        };
                    }
                    
                    masterSummary[cleanOfficeId][fileType + 'Count'] = totalCount || 0;
                    masterSummary[cleanOfficeId][fileType + 'Cost'] = totalCost || 0;
                    
                    if (index < 3) {
                        debugContent.innerHTML += `<p>Ø¹ÙŠÙ†Ø© ${fileType}: ${cleanOfficeId} - Ø¹Ø¯Ø¯: ${totalCount}, ØªÙƒÙ„ÙØ©: ${totalCost}</p>`;
                    }
                }
            });
        }

        function createMasterSummary() {
            debugContent.innerHTML += '<p><strong>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...</strong></p>';

            // Convert master summary to array and calculate totals (only offices with data)
            const summaryArray = Object.values(masterSummary)
                .filter(office => {
                    // Only include offices that have transactions in at least one system
                    const hasTransactions = office.atcCount > 0 || office.wepCount > 0 || office.pnrCount > 0 || 
                                          office.mptCount > 0 || office.mpeCount > 0 ||
                                          office.atcCost > 0 || office.wepCost > 0 || office.pnrCost > 0 || 
                                          office.mptCost > 0 || office.mpeCost > 0;
                    return hasTransactions;
                })
                .map(office => ({
                    'Office ID': office.officeId,
                    'Office Name': office.officeName,
                    'Office Arabic Name': office.officeArabicName,
                    'IATA Number': office.iataNumber,
                    'ATC Count': office.atcCount,
                    'ATC Cost': office.atcCost,
                    'WEP Count': office.wepCount,
                    'WEP Cost': office.wepCost,
                    'PNR Count': office.pnrCount,
                    'PNR Cost': office.pnrCost,
                    'MPT Count': office.mptCount,
                    'MPT Cost': office.mptCost,
                    'MPE Count': office.mpeCount,
                    'MPE Cost': office.mpeCost,
                    'Total Cost': office.atcCost + office.wepCost + office.pnrCost + office.mptCost + office.mpeCost,
                    'Total Count': office.atcCount + office.wepCount + office.pnrCount + office.mptCount + office.mpeCount
                }));

            debugContent.innerHTML += `<p>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ${summaryArray.length} Ù…ÙƒØªØ¨ Ù…Ø¹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p>`;

            // Sort by Total Cost (highest first), then by Office ID
            summaryArray.sort((a, b) => {
                if (b['Total Cost'] !== a['Total Cost']) {
                    return b['Total Cost'] - a['Total Cost'];
                }
                return a['Office ID'].localeCompare(b['Office ID']);
            });

            // Create worksheet
            const masterSheet = XLSX.utils.json_to_sheet(summaryArray);
            
            // Add to workbook
            consolidatedWorkbook.Sheets['Master_Summary'] = masterSheet;
            consolidatedWorkbook.SheetNames.unshift('Master_Summary'); // Add at beginning
        }

        function displayResults() {
            // Only show offices that have transactions in at least one system
            const summaryArray = Object.values(masterSummary)
                .filter(office => {
                    const hasTransactions = office.atcCount > 0 || office.wepCount > 0 || office.pnrCount > 0 || 
                                          office.mptCount > 0 || office.mpeCount > 0 ||
                                          office.atcCost > 0 || office.wepCost > 0 || office.pnrCost > 0 || 
                                          office.mptCost > 0 || office.mpeCost > 0;
                    return hasTransactions;
                })
                .map(office => ({
                    officeId: office.officeId,
                    officeName: office.officeName,
                    officeArabicName: office.officeArabicName,
                    iataNumber: office.iataNumber,
                    atcCount: office.atcCount,
                    atcCost: office.atcCost,
                    wepCount: office.wepCount,
                    wepCost: office.wepCost,
                    pnrCount: office.pnrCount,
                    pnrCost: office.pnrCost,
                    mptCount: office.mptCount,
                    mptCost: office.mptCost,
                    mpeCount: office.mpeCount,
                    mpeCost: office.mpeCost,
                    totalCost: office.atcCost + office.wepCost + office.pnrCost + office.mptCost + office.mpeCost,
                    totalCount: office.atcCount + office.wepCount + office.pnrCount + office.mptCount + office.mpeCount
                }));

            // Sort by Total Cost (highest first), then by Office ID
            summaryArray.sort((a, b) => {
                if (b.totalCost !== a.totalCost) {
                    return b.totalCost - a.totalCost;
                }
                return a.officeId.localeCompare(b.officeId);
            });

            summaryTableBody.innerHTML = summaryArray.map(office => `
                <tr>
                    <td><span class="office-id">${office.officeId}</span></td>
                    <td>${office.officeName}</td>
                    <td>${office.officeArabicName}</td>
                    <td>${office.iataNumber}</td>
                    <td class="count-cell">${office.atcCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.atcCost.toFixed(3)}</td>
                    <td class="count-cell">${office.wepCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.wepCost.toFixed(3)}</td>
                    <td class="count-cell">${office.pnrCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.pnrCost.toFixed(3)}</td>
                    <td class="count-cell">${office.mptCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.mptCost.toFixed(3)}</td>
                    <td class="count-cell">${office.mpeCount.toLocaleString()}</td>
                    <td class="cost-cell">${office.mpeCost.toFixed(3)}</td>
                    <td class="total-cell">${office.totalCost.toFixed(3)}</td>
                </tr>
            `).join('');
        }

        // Download consolidated file
        downloadBtn.addEventListener('click', () => {
            if (!consolidatedWorkbook) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            XLSX.writeFile(consolidatedWorkbook, 'bills_consolidated.xlsx');
        });

        // Generate individual office invoices
        generateInvoicesBtn.addEventListener('click', () => {
            if (!consolidatedWorkbook || !masterSummary) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©. ÙŠØ±Ø¬Ù‰ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            generateOfficeInvoices();
        });

        // Function to convert number to Arabic words
        function numberToArabic(num) {
            const ones = ['', 'ÙˆØ§Ø­Ø¯', 'Ø§Ø«Ù†Ø§Ù†', 'Ø«Ù„Ø§Ø«Ø©', 'Ø£Ø±Ø¨Ø¹Ø©', 'Ø®Ù…Ø³Ø©', 'Ø³ØªØ©', 'Ø³Ø¨Ø¹Ø©', 'Ø«Ù…Ø§Ù†ÙŠØ©', 'ØªØ³Ø¹Ø©'];
            const tens = ['', '', 'Ø¹Ø´Ø±ÙˆÙ†', 'Ø«Ù„Ø§Ø«ÙˆÙ†', 'Ø£Ø±Ø¨Ø¹ÙˆÙ†', 'Ø®Ù…Ø³ÙˆÙ†', 'Ø³ØªÙˆÙ†', 'Ø³Ø¨Ø¹ÙˆÙ†', 'Ø«Ù…Ø§Ù†ÙˆÙ†', 'ØªØ³Ø¹ÙˆÙ†'];
            const teens = ['Ø¹Ø´Ø±Ø©', 'Ø£Ø­Ø¯ Ø¹Ø´Ø±', 'Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±', 'Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±', 'Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø®Ù…Ø³Ø© Ø¹Ø´Ø±', 'Ø³ØªØ© Ø¹Ø´Ø±', 'Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±', 'Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±', 'ØªØ³Ø¹Ø© Ø¹Ø´Ø±'];
            const hundreds = ['', 'Ù…Ø§Ø¦Ø©', 'Ù…Ø¦ØªØ§Ù†', 'Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©', 'Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø®Ù…Ø³Ù…Ø§Ø¦Ø©', 'Ø³ØªÙ…Ø§Ø¦Ø©', 'Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©', 'Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©', 'ØªØ³Ø¹Ù…Ø§Ø¦Ø©'];

            if (num === 0) return 'ØµÙØ±';
            if (num < 0) return 'Ø³Ø§Ù„Ø¨ ' + numberToArabic(-num);

            let result = '';

            // Handle thousands
            if (num >= 1000) {
                const thousands = Math.floor(num / 1000);
                if (thousands === 1) {
                    result += 'Ø£Ù„Ù ';
                } else if (thousands === 2) {
                    result += 'Ø£Ù„ÙØ§Ù† ';
                } else if (thousands <= 10) {
                    result += ones[thousands] + ' Ø¢Ù„Ø§Ù ';
                } else {
                    result += numberToArabic(thousands) + ' Ø£Ù„Ù ';
                }
                num %= 1000;
            }

            // Handle hundreds
            if (num >= 100) {
                result += hundreds[Math.floor(num / 100)] + ' ';
                num %= 100;
            }

            // Handle tens and ones
            if (num >= 20) {
                result += tens[Math.floor(num / 10)];
                if (num % 10 !== 0) {
                    result += ' Ùˆ' + ones[num % 10];
                }
            } else if (num >= 10) {
                result += teens[num - 10];
            } else if (num > 0) {
                result += ones[num];
            }

            return result.trim();
        }

        function getCurrentDateArabic() {
            const date = new Date();
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            
            const months = [
                'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
            ];
            
            return `${day} ${months[month - 1]} ${year}`;
        }

        function generateOfficeInvoices() {
            try {
                progressDiv.style.display = 'block';
                progressText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„ÙØ±Ø¯ÙŠØ©...';
                
                // Create a new workbook for invoices
                const invoiceWorkbook = XLSX.utils.book_new();
                
                // Get offices that have transactions
                const officesWithTransactions = Object.values(masterSummary)
                    .filter(office => {
                        const hasTransactions = office.atcCount > 0 || office.wepCount > 0 || office.pnrCount > 0 || 
                                              office.mptCount > 0 || office.mpeCount > 0 ||
                                              office.atcCost > 0 || office.wepCost > 0 || office.pnrCost > 0 || 
                                              office.mptCost > 0 || office.mpeCost > 0;
                        return hasTransactions;
                    })
                    .sort((a, b) => a.officeId.localeCompare(b.officeId));

                debugContent.innerHTML += `<p>Ø¥Ù†Ø´Ø§Ø¡ ÙÙˆØ§ØªÙŠØ± Ù„Ù€ ${officesWithTransactions.length} Ù…ÙƒØªØ¨...</p>`;

                // Create invoice sheet for each office
                officesWithTransactions.forEach((office, index) => {
                    progressText.textContent = `Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…ÙƒØªØ¨ ${office.officeId} (${index + 1}/${officesWithTransactions.length})...`;
                    
                    const currentDate = getCurrentDateArabic();
                    const currentYear = new Date().getFullYear();
                    
                    // Calculate totals using the cost values
                    let subtotal = 0;
                    let rowCounter = 1;
                    const serviceRows = [];

                    // Add service lines (only for services with non-zero values)
                    if (office.mpeCost > 0) {
                        serviceRows.push([
                            rowCounter++, 
                            'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPE', 
                            office.mpeCount, 
                            office.mpeCost.toFixed(3)
                        ]);
                        subtotal += office.mpeCost;
                    }
                    
                    if (office.mptCost > 0) {
                        serviceRows.push([
                            rowCounter++, 
                            'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPT', 
                            office.mptCount, 
                            office.mptCost.toFixed(3)
                        ]);
                        subtotal += office.mptCost;
                    }

                    if (office.atcCost > 0) {
                        serviceRows.push([
                            rowCounter++, 
                            'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ°Ø§ÙƒØ± ATC', 
                            office.atcCount, 
                            office.atcCost.toFixed(3)
                        ]);
                        subtotal += office.atcCost;
                    }

                    if (office.wepCost > 0) {
                        serviceRows.push([
                            rowCounter++, 
                            'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© WEP', 
                            office.wepCount, 
                            office.wepCost.toFixed(3)
                        ]);
                        subtotal += office.wepCost;
                    }

                    if (office.pnrCost > 0) {
                        serviceRows.push([
                            rowCounter++, 
                            'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª PNR', 
                            office.pnrCount, 
                            office.pnrCost.toFixed(3)
                        ]);
                        subtotal += office.pnrCost;
                    }

                    const stampTax = subtotal * 0.01;
                    const totalCost = subtotal + stampTax;
                    const totalInWords = numberToArabic(Math.floor(totalCost)) + ' Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ';

                    // Create Arabic invoice data with RTL layout
                    const invoiceData = [
                        ['', '', '', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', 'Ø´Ø±ÙƒØ© Ø£Ù…Ø§Ø¯ÙŠÙˆØ³ Ù„ÙŠØ¨ÙŠØ§ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', '', `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${currentDate}`, '', ''],
                        ['', '', '', '', '', ''],
                        ['', `Ø§Ù„Ø§Ø®ÙˆØ© / ${office.officeArabicName}`, '', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', 'Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙŠØ© ØŒØŒØŒ', '', `Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ§ØªØ§: ${office.iataNumber}`, '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: _____ / ${currentYear}`, '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', 'Ù†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø³Ø¯Ø§Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠÙ†Ø© Ø£Ø¯Ù†Ø§Ù‡ :', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['', '', '', '', '', ''],
                        ['Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø¯.Ù„)', 'Ø§Ù„ÙƒÙ…ÙŠØ©', 'Ø§Ù„Ø¨ÙŠØ§Ù†', 'Ø±.Øª', '', ''],
                        ['', '', '', '', '', '']
                    ];

                    // Add service rows in the new order: Ø§Ù„Ù‚ÙŠÙ…Ø©, Ø§Ù„ÙƒÙ…ÙŠØ©, Ø§Ù„Ø¨ÙŠØ§Ù†, Ø±.Øª
                    serviceRows.forEach(row => {
                        invoiceData.push([
                            row[3], // Ø§Ù„Ù‚ÙŠÙ…Ø©
                            row[2], // Ø§Ù„ÙƒÙ…ÙŠØ©
                            row[1], // Ø§Ù„Ø¨ÙŠØ§Ù†
                            row[0], // Ø±.Øª
                            '', 
                            ''
                        ]);
                    });

                    // Add spacing and totals
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push([subtotal.toFixed(3), '', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©', '', '', '']);
                    invoiceData.push([stampTax.toFixed(3), '', 'Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ù…ØºØ© 1%', '', '', '']);
                    invoiceData.push([totalCost.toFixed(3), '', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', `Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø­Ø±ÙˆÙ: ${totalInWords}`, '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯:', '', '', '']);
                    invoiceData.push(['', '', 'ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù†Ù‚Ø¯Ø§Ù‹ Ø£Ùˆ Ø¨ØµÙƒ Ù…ØµØ¯Ù‚ Ø¨Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø´Ø±ÙƒØ©', '', '', '']);
                    invoiceData.push(['', '', 'Ø¨Ø¥Ø³Ù… Ø´Ø±ÙƒØ© Ø£Ù…Ø§Ø¯ÙŠÙŠÙˆØ³ Ù„ÙŠØ¨ÙŠØ§ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©', '', '', '']);
                    invoiceData.push(['', '', 'Ø£Ùˆ Ø¨Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© Ø±Ù‚Ù… 0900003088', '', '', '']);
                    invoiceData.push(['', '', 'Ù„Ø¯Ù‰ Ø§Ù„Ù…ØµØ±Ù Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ.', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', 'ÙˆØ§Ù„Ø³Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ Ø¹Ù„ÙŠÙƒÙ… Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù„Ø§Ù…', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', '.........................', '', '', '']);
                    invoiceData.push(['', '', 'ÙÙˆØ²ÙŠ Ø§Ù„ØµØ¯ÙŠÙ‚ Ø§Ø¨ÙˆØ­Ù…ÙŠØ¯Ø©', '', '', '']);
                    invoiceData.push(['', '', 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© Ùˆ Ø§Ù„Ù…Ø§Ù„ÙŠØ©', '', '', '']);
                    invoiceData.push(['', '', '', '', '', '']);
                    invoiceData.push(['', '', 'Ù…Ù„Ù Ø§Ù„ØµØ§Ø¯Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ Ø§ÙƒØ±Ù…', '', '', '']);

                    // Create worksheet
                    const invoiceSheet = XLSX.utils.aoa_to_sheet(invoiceData);
                    
                    // Set RTL direction for the worksheet
                    if (!invoiceSheet['!ref']) invoiceSheet['!ref'] = 'A1:F60';
                    
                    // Add worksheet properties for RTL
                    invoiceSheet['!worksheetViews'] = [{
                        // rightToLeft: true,
                        showGridLines: true,
                        showRowColHeaders: true,
                        tabSelected: true,
                        topLeftCell: 'A1'
                    }];
                    
                    // Set column widths for Arabic text (6 columns now)
                    invoiceSheet['!cols'] = [
                        { width: 15 }, // Ø§Ù„Ù‚ÙŠÙ…Ø©
                        { width: 12 }, // Ø§Ù„ÙƒÙ…ÙŠØ©
                        { width: 50 }, // Ø§Ù„Ø¨ÙŠØ§Ù†
                        { width: 8 },  // Ø±.Øª
                        { width: 15 }, // Extra space
                        { width: 15 }  // Extra space
                    ];
                    
                    // Set cell styles for RTL text alignment
                    const range = XLSX.utils.decode_range(invoiceSheet['!ref']);
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!invoiceSheet[cellAddress]) continue;
                            
                            if (!invoiceSheet[cellAddress].s) invoiceSheet[cellAddress].s = {};
                            invoiceSheet[cellAddress].s.alignment = {
                                horizontal: 'right',
                                vertical: 'center',
                                readingOrder: 2 // RTL reading order
                            };
                        }
                    }

                    // Add merges for better layout
                    if (!invoiceSheet['!merges']) invoiceSheet['!merges'] = [];
                    
                    // Merge company name cell (spans 4 columns)
                    invoiceSheet['!merges'].push({ s: { r: 2, c: 1 }, e: { r: 2, c: 4 } });
                    // Merge date cell (spans 2 columns)
                    invoiceSheet['!merges'].push({ s: { r: 4, c: 2 }, e: { r: 4, c: 4 } });
                    // Merge office name cell (spans 4 columns for wider display)
                    invoiceSheet['!merges'].push({ s: { r: 6, c: 1 }, e: { r: 6, c: 4 } });
                    // Merge greeting and IATA cells (2 columns each)
                    invoiceSheet['!merges'].push({ s: { r: 8, c: 1 }, e: { r: 8, c: 2 } });
                    invoiceSheet['!merges'].push({ s: { r: 8, c: 3 }, e: { r: 8, c: 4 } });
                    // Merge invoice number cell (spans 3 columns)
                    invoiceSheet['!merges'].push({ s: { r: 11, c: 2 }, e: { r: 11, c: 4 } });
                    // Merge request cell (spans 4 columns)
                    invoiceSheet['!merges'].push({ s: { r: 13, c: 2 }, e: { r: 13, c: 5 } });

                    // Create a clean sheet name (remove special characters)
                    const cleanOfficeId = office.officeId.replace(/[^\w\s]/gi, '').substring(0, 31);
                    const sheetName = `ÙØ§ØªÙˆØ±Ø©_${cleanOfficeId}`;
                    
                    // Add sheet to workbook
                    XLSX.utils.book_append_sheet(invoiceWorkbook, invoiceSheet, sheetName);
                });

                // Create a summary sheet with all invoices in RTL
                const allInvoicesData = [
                    ['', '', '', '', '', '', 'Ù…Ù„Ø®Øµ ÙÙˆØ§ØªÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ØªØ¨ - AMADEUS SERVICES'],
                    ['', '', '', '', '', '', ''],
                    ['Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯', 'Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ§ØªØ§', 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨', 'Ø±Ù…Ø² Ø§Ù„Ù…ÙƒØªØ¨'],
                    ['', '', '', '', '', '', '']
                ];

                officesWithTransactions.forEach(office => {
                    const totalCost = office.atcCost + office.wepCost + office.pnrCost + office.mptCost + office.mpeCost;
                    const totalCount = office.atcCount + office.wepCount + office.pnrCount + office.mptCount + office.mpeCount;
                    const stampTax = totalCost * 0.01;
                    const finalTotal = totalCost + stampTax;
                    
                    allInvoicesData.push([
                        'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
                        finalTotal.toFixed(3),
                        totalCount.toLocaleString(),
                        office.iataNumber,
                        office.officeArabicName,
                        office.officeName,
                        office.officeId
                    ]);
                });

                const summarySheet = XLSX.utils.aoa_to_sheet(allInvoicesData);
                
                // Set RTL direction for summary sheet
                summarySheet['!worksheetViews'] = [{
                    rightToLeft: true,
                    showGridLines: true,
                    showRowColHeaders: true,
                    tabSelected: true,
                    topLeftCell: 'A1'
                }];
                
                summarySheet['!cols'] = [
                    { width: 15 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                    { width: 15 }, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                    { width: 15 }, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø¯
                    { width: 15 }, // Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ§ØªØ§
                    { width: 25 }, // Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                    { width: 25 }, // Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨
                    { width: 15 }  // Ø±Ù…Ø² Ø§Ù„Ù…ÙƒØªØ¨
                ];
                
                // Set cell styles for RTL text alignment in summary sheet
                if (summarySheet['!ref']) {
                    const range = XLSX.utils.decode_range(summarySheet['!ref']);
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!summarySheet[cellAddress]) continue;
                            
                            if (!summarySheet[cellAddress].s) summarySheet[cellAddress].s = {};
                            summarySheet[cellAddress].s.alignment = {
                                horizontal: 'right',
                                vertical: 'center',
                                readingOrder: 2 // RTL reading order
                            };
                        }
                    }
                }

                // Add summary sheet at the beginning
                XLSX.utils.book_append_sheet(invoiceWorkbook, summarySheet, 'Ù…Ù„Ø®Øµ_Ø¬Ù…ÙŠØ¹_Ø§Ù„ÙÙˆØ§ØªÙŠØ±');
                
                // Set workbook properties for RTL
                if (!invoiceWorkbook.Workbook) invoiceWorkbook.Workbook = {};
                if (!invoiceWorkbook.Workbook.Views) invoiceWorkbook.Workbook.Views = [];
                invoiceWorkbook.Workbook.Views.push({
                    rightToLeft: true
                });
                
                // Move summary to first position
                const sheetNames = invoiceWorkbook.SheetNames;
                const summaryIndex = sheetNames.indexOf('Ù…Ù„Ø®Øµ_Ø¬Ù…ÙŠØ¹_Ø§Ù„ÙÙˆØ§ØªÙŠØ±');
                if (summaryIndex > 0) {
                    sheetNames.splice(summaryIndex, 1);
                    sheetNames.unshift('Ù…Ù„Ø®Øµ_Ø¬Ù…ÙŠØ¹_Ø§Ù„ÙÙˆØ§ØªÙŠØ±');
                }

                // Download the invoice workbook
                progressText.textContent = 'ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ±...';
                XLSX.writeFile(invoiceWorkbook, 'ÙÙˆØ§ØªÙŠØ±_Ù…ÙƒØ§ØªØ¨_Ø£Ù…Ø§Ø¯ÙŠÙˆØ³.xlsx');
                
                debugContent.innerHTML += `<p><strong>Ù†Ø¬Ø­!</strong> ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${officesWithTransactions.length} ÙØ§ØªÙˆØ±Ø© ÙØ±Ø¯ÙŠØ© Ø¹Ø±Ø¨ÙŠØ©</p>`;
                alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${officesWithTransactions.length} ÙØ§ØªÙˆØ±Ø© ÙØ±Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³Ù…: ÙÙˆØ§ØªÙŠØ±_Ù…ÙƒØ§ØªØ¨_Ø£Ù…Ø§Ø¯ÙŠÙˆØ³.xlsx`);
                
            } catch (error) {
                console.error('Error generating invoices:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ' + error.message);
                debugContent.innerHTML += `<p><strong>Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</strong> ${error.message}</p>`;
            } finally {
                progressDiv.style.display = 'none';
            }
        }
    </script>
</body>
</html>
