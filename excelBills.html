<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills Invoice Generator</title>
    <style>
        body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            direction: rtl;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .description {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
        }

        .upload-section {
            margin: 2rem 0;
            padding: 2rem;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .file-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .file-group h3 {
            margin-top: 0;
            color: #007cba;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-input {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            direction: ltr;
        }

        .file-counter {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
        }

        .file-list {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin: 0.3rem 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .file-name {
            font-weight: 500;
            color: #495057;
            flex-grow: 1;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.9rem;
            margin: 0 1rem;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .add-more-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .add-more-btn:hover {
            background: #138496;
        }

        .clear-all-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .process-btn, .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 0.5rem;
            transition: background-color 0.2s;
        }

        .process-btn:hover:not(:disabled) {
            background: #218838;
        }

        .process-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .download-btn {
            background: #007cba;
        }

        .download-btn:hover {
            background: #005a87;
        }

        .results-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #28a745;
            display: none;
        }

        .results-section h3 {
            color: #28a745;
            margin-top: 0;
        }

        .table-container {
            overflow-x: auto;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            direction: rtl;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9rem;
            direction: rtl;
        }

        th, td {
            padding: 10px;
            text-align: right;
            border: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        .office-id {
            background: #e7f3ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-family: monospace;
        }

        .progress {
            margin: 1rem 0;
            padding: 1rem;
            background: #e7f3ff;
            border-radius: 6px;
            display: none;
        }

        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 6px;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-card h4 {
            color: #28a745;
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .month-badge {
            background: #ffc107;
            color: #333;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin: 0 2px;
            display: inline-block;
        }

        .bill-number-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #e7f3ff;
            border: 2px solid #007cba;
            border-radius: 8px;
        }

        .bill-number-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #007cba;
            font-size: 1.1rem;
        }

        .bill-number-input {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border: 2px solid #007cba;
            border-radius: 6px;
            text-align: center;
            direction: ltr;
            font-weight: bold;
        }

        .bill-number-input:focus {
            outline: none;
            border-color: #005a87;
            box-shadow: 0 0 0 3px rgba(0, 124, 186, 0.1);
        }

        .hint {
            margin-top: 0.5rem;
            color: #666;
            font-size: 0.9rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <nav style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem 0;
        margin: -2rem -2rem 2rem -2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    ">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
            <h2 style="color: white; margin: 0 0 1rem 0; text-align: center; font-size: 1.5rem;">
               Amadeus Reports Processing Suite
            </h2>
            <h2 style="color: white; margin: 0 0 1rem 0; text-align: center; font-size: 1.5rem; direction: rtl;">
           Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ù…Ø§Ø¯ÙŠÙˆØ³
        </h2>
            <div style="
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                justify-content: center;
                align-items: center;
            ">
                <a href="ATC&MPT.html" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    text-decoration: none;
                    padding: 8px 16px;
                    border-radius: 25px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255,255,255,0.3);
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                   ATC & MPT Reports
                </a>
                <a href="wep.html" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    text-decoration: none;
                    padding: 8px 16px;
                    border-radius: 25px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255,255,255,0.3);
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                   WEP Reports
                </a>
                <a href="pnr.html" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    text-decoration: none;
                    padding: 8px 16px;
                    border-radius: 25px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255,255,255,0.3);
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                   PNR Reports
                </a>
                <a href="mpe.html" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    text-decoration: none;
                    padding: 8px 16px;
                    border-radius: 25px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255,255,255,0.3);
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                     MPE Reports
                </a>
                <a href="invoice.html" style="
                    background: rgba(255,255,255,0.2);
                    color: white;
                    text-decoration: none;
                    padding: 8px 16px;
                    border-radius: 25px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    border: 1px solid rgba(255,255,255,0.3);
                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                   onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                     Consolidator Ø§Ù„Ù…ÙˆØ­Ø¯
                </a>
               <a href="#" style="
                    background: rgba(255,255,255,0.4);
                    color: white;
                    text-decoration: none;
                    padding: 8px 16px;
                    border-radius: 25px;
                    font-size: 0.9rem;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    border: 2px solid rgba(255,255,255,0.6);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    pointer-events: none;
                ">
                     Excel Bills Generator
                </a>
            </div>
            <p style="
                color: rgba(255,255,255,0.9);
                text-align: center;
                margin: 1rem 0 0 0;
                font-size: 0.85rem;
            ">
                Generate individual invoices from Amosh bills files with automatic month extraction
            </p>
            <p style="
                color: rgba(255,255,255,0.9);
                text-align: center;
                margin: 1rem 0 0 0;
                font-size: 0.85rem;
                direction: rtl;
            ">
                Ø¥Ù†Ø´Ø§Ø¡ ÙÙˆØ§ØªÙŠØ± ÙØ±Ø¯ÙŠØ© Ù…Ù† Ù…Ù„ÙØ§Øª Amosh bills Ù…Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø´Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        </p>
        </div>
    </nav>

    <div class="container">
        <h1>Ù…ÙˆÙ„Ø¯ ÙÙˆØ§ØªÙŠØ± Excel Bills Generator</h1>
        <p class="description">ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¢Ù† Ù…Ù„ÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø´Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
        <p class="description">Now supports multiple files with automatic month extraction</p>

        <div class="upload-section">
            <div class="file-group">
                <h3>
                    ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Amosh bills.xlsx
                    <span class="file-counter" id="fileCounter">0</span>
                </h3>
                <input type="file" id="amoshFile" class="file-input" accept=".xlsx,.xls" multiple />
                <button class="add-more-btn" onclick="document.getElementById('amoshFile').click()">
                    Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
                </button>
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Invoice Number Input Section -->
            <div class="bill-number-section">
                <label class="bill-number-label" for="startingInvoiceNumber">ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ - Starting Invoice Number</label>
                <input
                    type="number"
                    id="startingInvoiceNumber"
                    class="bill-number-input"
                    placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ù…Ø«Ø§Ù„: 30)"
                    min="1"
                    value="1"
                />
                <div class="hint">
                    ğŸ’¡ Ø³ÙŠØªÙ… ØªØ±Ù‚ÙŠÙ… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ù…ØªØªØ§Ù„ÙŠ Ù„ÙƒÙ„ Ù…ÙƒØªØ¨
                </div>
                <div class="hint">
                    Invoices will be numbered automatically and sequentially for each office
                </div>
            </div>

            <div class="progress" id="progressDiv">
                <p id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
            </div>

            <button id="processBtn" class="process-btn" disabled>
                Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ± - Process Files & Generate Invoices
            </button>
        </div>

        <div id="resultsSection" class="results-section">
            <h3>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ - Results</h3>
            <div id="summaryContent"></div>
            <button id="downloadBtn" class="download-btn">
                ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ± - Download Invoices
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      let uploadedFiles = [];
      let processedData = {};
      let invoiceWorkbook = null;

      const amoshFile = document.getElementById("amoshFile");
      const processBtn = document.getElementById("processBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const progressDiv = document.getElementById("progressDiv");
      const progressText = document.getElementById("progressText");
      const resultsSection = document.getElementById("resultsSection");
      const summaryContent = document.getElementById("summaryContent");
      const fileList = document.getElementById("fileList");
      const fileCounter = document.getElementById("fileCounter");

      amoshFile.addEventListener("change", (e) => {
        handleFileUpload(e.target.files);
        e.target.value = ""; // Clear so same file can be added again
      });

      function handleFileUpload(files) {
        Array.from(files).forEach((file) => {
          // Check for duplicates
          const isDuplicate = uploadedFiles.some(
            (f) => f.name === file.name && f.size === file.size
          );
          if (!isDuplicate) {
            uploadedFiles.push(file);
          }
        });
        updateFileDisplay();
      }

      function updateFileDisplay() {
        fileCounter.textContent = uploadedFiles.length;
        processBtn.disabled = uploadedFiles.length === 0;

        if (uploadedFiles.length === 0) {
          fileList.style.display = "none";
          return;
        }

        fileList.style.display = "block";
        fileList.innerHTML = uploadedFiles
          .map(
            (file, index) => `
                <div class="file-item">
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                    <button class="remove-btn" onclick="removeFile(${index})">Ø­Ø°Ù</button>
                </div>
            `
          )
          .join("");
      }

      function removeFile(index) {
        uploadedFiles.splice(index, 1);
        updateFileDisplay();
      }

      processBtn.addEventListener("click", async () => {
        if (uploadedFiles.length === 0) return;

        progressDiv.style.display = "block";
        processBtn.disabled = true;

        try {
          await processAllAmoshFiles();
          generateInvoices();
          displayResults();
          resultsSection.style.display = "block";
        } catch (error) {
          alert("Ø®Ø·Ø£: " + error.message);
          console.error(error);
        } finally {
          progressDiv.style.display = "none";
          processBtn.disabled = false;
        }
      });

      async function processAllAmoshFiles() {
        processedData = {};

        for (let i = 0; i < uploadedFiles.length; i++) {
          const file = uploadedFiles[i];
          progressText.textContent = `Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù ${i + 1}/${
            uploadedFiles.length
          }: ${file.name}`;
          await processAmoshFile(file);
        }

        console.log("Processed offices:", Object.keys(processedData).length);
      }

      async function processAmoshFile(file) {
        const data = await readFile(file);
        const workbook = XLSX.read(data);

        const serviceSheets = {
          ATC: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ°Ø§ÙƒØ± ATC",
          "MPE ": "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPE",
          MPE: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPE",
          MPT: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPT",
          PNR: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª PNR",
          "Web Trax": "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© WEP",
          " AUTTP ": " Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠÙ‡ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¯Ø§ÙƒØ± Ø§Ù„ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‡Unused e-Document",
          AUTTP: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠÙ‡ Ø¹Ø±Ø¶ Ø§Ù„ØªØ¯Ø§ÙƒØ± Ø§Ù„ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‡Unused e-Document",
          "AOS Std Implementation Fee": "Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
        };

        for (let [sheetName, serviceDescription] of Object.entries(
          serviceSheets
        )) {
          if (workbook.Sheets[sheetName]) {
            progressText.textContent = `Ù…Ø¹Ø§Ù„Ø¬Ø© ${sheetName} Ù…Ù† ${file.name}...`;
            processSheet(
              workbook.Sheets[sheetName],
              serviceDescription,
              sheetName
            );
          }
        }
      }

      function extractMonthFromHeader(headerText) {
        if (!headerText) return "";

        const monthMap = {
          ÙŠÙ†Ø§ÙŠØ±: "01",
          january: "01",
          jan: "01",
          ÙØ¨Ø±Ø§ÙŠØ±: "02",
          february: "02",
          feb: "02",
          Ù…Ø§Ø±Ø³: "03",
          march: "03",
          mar: "03",
          Ø£Ø¨Ø±ÙŠÙ„: "04",
          Ø¥Ø¨Ø±ÙŠÙ„: "04",
          april: "04",
          apr: "04",
          Ù…Ø§ÙŠÙˆ: "05",
          Ù…Ø§ÙŠ: "05",
          may: "05",
          ÙŠÙˆÙ†ÙŠÙˆ: "06",
          ÙŠÙˆÙ†ÙŠÙ‡: "06",
          june: "06",
          jun: "06",
          ÙŠÙˆÙ„ÙŠÙˆ: "07",
          ÙŠÙˆÙ„ÙŠÙ‡: "07",
          july: "07",
          jul: "07",
          Ø£ØºØ³Ø·Ø³: "08",
          Ø§ØºØ³Ø·Ø³: "08",
          august: "08",
          aug: "08",
          Ø³Ø¨ØªÙ…Ø¨Ø±: "09",
          september: "09",
          sep: "09",
          Ø£ÙƒØªÙˆØ¨Ø±: "10",
          Ø§ÙƒØªÙˆØ¨Ø±: "10",
          october: "10",
          oct: "10",
          Ù†ÙˆÙÙ…Ø¨Ø±: "11",
          november: "11",
          nov: "11",
          Ø¯ÙŠØ³Ù…Ø¨Ø±: "12",
          december: "12",
          dec: "12",
        };

        const lowerText = headerText.toLowerCase();

        for (let [monthName, monthNum] of Object.entries(monthMap)) {
          if (lowerText.includes(monthName.toLowerCase())) {
            return monthNum;
          }
        }

        return "";
      }

      function processSheet(sheet, serviceDescription, sheetName) {
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

        // Extract month from first row header
        let monthNumber = "";
        if (data.length > 0 && data[0][0]) {
          monthNumber = extractMonthFromHeader(data[0][0].toString());
        }

        // Find header row (contains "Office ID")
        let headerRowIndex = -1;
        for (let i = 0; i < data.length; i++) {
          if (data[i].includes("Office ID")) {
            headerRowIndex = i;
            break;
          }
        }

        if (headerRowIndex === -1) return;

        const headers = data[headerRowIndex];
        const officeIdIndex = headers.indexOf("Office ID");
        const companyNameIndex = headers.indexOf("Company Name");
        const arabicNameIndex = headers.indexOf("Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©");
        const qtyIndex =
          headers.indexOf("Ø§Ù„ÙƒÙ…ÙŠØ©") !== -1
            ? headers.indexOf("Ø§Ù„ÙƒÙ…ÙŠØ©")
            : headers.indexOf("Qty");
        const priceIndex =
          headers.indexOf("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹") !== -1
            ? headers.indexOf("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹")
            : headers.indexOf("Sales Price");

        // Process data rows
        for (let i = headerRowIndex + 1; i < data.length; i++) {
          const row = data[i];
          const officeId = row[officeIdIndex];
          const companyName = row[companyNameIndex];
          const arabicName = row[arabicNameIndex];
          const quantity = parseFloat(row[qtyIndex]) || 0;
          const price = parseFloat(row[priceIndex]) || 0;

          if (!officeId || (!quantity && !price)) continue;

          if (!processedData[officeId]) {
            processedData[officeId] = {
              officeId: officeId,
              companyName: companyName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
              arabicName: arabicName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
              services: [],
            };
          }

          if (quantity > 0 || price > 0) {
            // Add month to service description
            let descriptionWithMonth = serviceDescription;
            if (monthNumber) {
              descriptionWithMonth += ` Ù„Ø´Ù‡Ø± ${monthNumber}`;
            }

            processedData[officeId].services.push({
              description: descriptionWithMonth,
              quantity: quantity,
              price: price,
              sheet: sheetName,
              month: monthNumber,
            });
          }
        }
      }

      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      function formatNumber(num) {
        const parts = num.toFixed(3).split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
      }

      function numberToArabic(num) {
        const ones = [
          "",
          "ÙˆØ§Ø­Ø¯",
          "Ø§Ø«Ù†Ø§Ù†",
          "Ø«Ù„Ø§Ø«Ø©",
          "Ø£Ø±Ø¨Ø¹Ø©",
          "Ø®Ù…Ø³Ø©",
          "Ø³ØªØ©",
          "Ø³Ø¨Ø¹Ø©",
          "Ø«Ù…Ø§Ù†ÙŠØ©",
          "ØªØ³Ø¹Ø©",
        ];
        const tens = [
          "",
          "",
          "Ø¹Ø´Ø±ÙˆÙ†",
          "Ø«Ù„Ø§Ø«ÙˆÙ†",
          "Ø£Ø±Ø¨Ø¹ÙˆÙ†",
          "Ø®Ù…Ø³ÙˆÙ†",
          "Ø³ØªÙˆÙ†",
          "Ø³Ø¨Ø¹ÙˆÙ†",
          "Ø«Ù…Ø§Ù†ÙˆÙ†",
          "ØªØ³Ø¹ÙˆÙ†",
        ];
        const teens = [
          "Ø¹Ø´Ø±Ø©",
          "Ø£Ø­Ø¯ Ø¹Ø´Ø±",
          "Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±",
          "Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±",
          "Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±",
          "Ø®Ù…Ø³Ø© Ø¹Ø´Ø±",
          "Ø³ØªØ© Ø¹Ø´Ø±",
          "Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±",
          "Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±",
          "ØªØ³Ø¹Ø© Ø¹Ø´Ø±",
        ];
        const hundreds = [
          "",
          "Ù…Ø§Ø¦Ø©",
          "Ù…Ø¦ØªØ§Ù†",
          "Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©",
          "Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©",
          "Ø®Ù…Ø³Ù…Ø§Ø¦Ø©",
          "Ø³ØªÙ…Ø§Ø¦Ø©",
          "Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©",
          "Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©",
          "ØªØ³Ø¹Ù…Ø§Ø¦Ø©",
        ];

        if (num === 0) return "ØµÙØ±";
        if (num < 0) return "Ø³Ø§Ù„Ø¨ " + numberToArabic(-num);

        let result = "";

        // Handle thousands
        if (num >= 1000) {
          const thousands = Math.floor(num / 1000);
          if (thousands === 1) {
            result += "Ø£Ù„Ù ";
          } else if (thousands === 2) {
            result += "Ø£Ù„ÙØ§Ù† ";
          } else if (thousands <= 10) {
            result += ones[thousands] + " Ø¢Ù„Ø§Ù ";
          } else {
            result += numberToArabic(thousands) + " Ø£Ù„Ù ";
          }
          num %= 1000;

          // Add "Ùˆ" if there's a remainder
          if (num > 0) {
            result += "Ùˆ ";
          }
        }

        // Handle hundreds
        if (num >= 100) {
          result += hundreds[Math.floor(num / 100)];
          num %= 100;

          // Add "Ùˆ" if there's a remainder
          if (num > 0) {
            result += " Ùˆ ";
          } else {
            result += " ";
          }
        }

        // Handle tens and ones - ones come before tens in Arabic
        if (num >= 20) {
          const onesDigit = num % 10;
          const tensDigit = Math.floor(num / 10);

          if (onesDigit !== 0) {
            result += ones[onesDigit] + " Ùˆ" + tens[tensDigit];
          } else {
            result += tens[tensDigit];
          }
        } else if (num >= 10) {
          result += teens[num - 10];
        } else if (num > 0) {
          result += ones[num];
        }

        return result.trim();
      }

      function getCurrentDateArabic() {
        const date = new Date();
        const months = [
          "ÙŠÙ†Ø§ÙŠØ±",
          "ÙØ¨Ø±Ø§ÙŠØ±",
          "Ù…Ø§Ø±Ø³",
          "Ø£Ø¨Ø±ÙŠÙ„",
          "Ù…Ø§ÙŠÙˆ",
          "ÙŠÙˆÙ†ÙŠÙˆ",
          "ÙŠÙˆÙ„ÙŠÙˆ",
          "Ø£ØºØ³Ø·Ø³",
          "Ø³Ø¨ØªÙ…Ø¨Ø±",
          "Ø£ÙƒØªÙˆØ¨Ø±",
          "Ù†ÙˆÙÙ…Ø¨Ø±",
          "Ø¯ÙŠØ³Ù…Ø¨Ø±",
        ];
        return `${date.getDate()} ${
          months[date.getMonth()]
        } ${date.getFullYear()}`;
      }

      function generateInvoices() {
        progressText.textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ±...";

        invoiceWorkbook = XLSX.utils.book_new();
        const offices = Object.values(processedData).sort((a, b) =>
          a.officeId.localeCompare(b.officeId)
        );

        const summaryData = [
          [
            "",
            "Ù…Ù„Ø®Øµ ÙÙˆØ§ØªÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ØªØ¨ - All Offices Summary",
            "",
            "",
            "",
            "",
            "",
          ],
          ["", "", "", "", "", "", ""],
          [
            "Ø±Ù…Ø² Ø§Ù„Ù…ÙƒØªØ¨",
            "Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨",
            "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ",
            "Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª",
            "Ø§Ù„Ø£Ø´Ù‡Ø±",
            "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
            "Ø§Ù„Ø­Ø§Ù„Ø©",
          ],
          ["", "", "", "", "", "", ""],
        ];

        let startingNumber =
          parseInt(document.getElementById("startingInvoiceNumber").value) || 1;
        let currentInvoiceNumber = startingNumber;

        offices.forEach((office) => {
          const currentDate = getCurrentDateArabic();
          const currentYear = new Date().getFullYear();

          let subtotal = 0;
          let rowCounter = 1;
          const serviceRows = [];
          const months = new Set();

          const groupedServices = {};
          office.services.forEach((service) => {
            const baseDescription = service.description.replace(
              /\s*Ù„Ø´Ù‡Ø±\s*\d+\s*$/,
              ""
            );

            if (!groupedServices[baseDescription]) {
              groupedServices[baseDescription] = {
                quantity: 0,
                price: 0,
                months: new Set(),
              };
            }

            groupedServices[baseDescription].quantity += service.quantity;
            groupedServices[baseDescription].price += service.price;
            if (service.month) {
              groupedServices[baseDescription].months.add(service.month);
              months.add(service.month);
            }
          });

          Object.keys(groupedServices)
            .sort()
            .forEach((baseDescription) => {
              const group = groupedServices[baseDescription];
              const monthsArray = Array.from(group.months).sort();

              let finalDescription = baseDescription;
              if (monthsArray.length > 0) {
                finalDescription += ` Ù„Ø´Ù‡Ø± ${monthsArray.join(",")}`;
              }

              serviceRows.push([
                rowCounter++,
                finalDescription,
                group.quantity,
                group.price.toFixed(3),
              ]);
              subtotal += group.price;
            });

          // Split total into dinars and fils
          const dinars = Math.floor(subtotal);
          const fils = Math.round((subtotal - dinars) * 1000);

          let totalInWords = '';
          if (dinars > 0) {
            totalInWords = numberToArabic(dinars) + ' Ø¯ÙŠÙ†Ø§Ø±Ù„Ø§ØºÙŠØ±  ';
          }

          if (fils > 0) {
            if (dinars > 0) {
              totalInWords += ' Ùˆ ' + fils.toString().padStart(3, '0') + ' Ø¯Ø±Ù‡Ù… Ù„Ø§ØºÙŠØ±';
            } else {
              totalInWords = fils.toString().padStart(3, '0') + ' Ø¯Ø±Ù‡Ù… Ù„Ø§ØºÙŠØ±';
            }
          } else if (dinars === 0) {
            totalInWords = 'ØµÙØ± Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ';
          }

          // MATCH THE EXACT LAYOUT FROM invoiceWithBillNumber.html
          const invoiceData = [
            ['', '', '', '', '', ''],
            ['', '', '', '', '', ''],
            ['Ø´Ø±ÙƒØ© Ø£Ù…Ø§Ø¯ÙŠÙˆØ³ Ù„ÙŠØ¨ÙŠØ§ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©', '', '', '', '', ''],
            ['', '', '', '', '', ''],
            [`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${currentDate}`, '', '', '', '', ''],
            ['', '', '', '', '', ''],
            ['', '', `Ø§Ù„Ø§Ø®ÙˆØ© / ${office.arabicName}`, '', ''],
            ['', '', '', '', '', ''],
            [`Ø±Ù‚Ù… Ø§Ù„Ù…ÙƒØªØ¨: ${office.officeId}`, '',  'Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙŠØ© ØŒØŒØŒ', '',''],
            ['', '', '', '', '', ''],
            ['', '', '', '', '', ''],
            [`ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: ${currentInvoiceNumber} / ${currentYear}`, '', '', '',''],
            ['', '', '', '', '', ''],
            ['', '', 'Ù†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø³Ø¯Ø§Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠÙ†Ø© Ø£Ø¯Ù†Ø§Ù‡ :', '', ''],
            ['', '', '', '', '', ''],
            ['', '', '', '', '', ''],
            ['Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø¯.Ù„)' , 'Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ø¨ÙŠØ§Ù†','Ø±.Øª',''],
            ['', '', '', '', '', '']
          ];

          currentInvoiceNumber++;

          serviceRows.forEach(row => {
            invoiceData.push([
              row[3],  // Ø§Ù„Ù‚ÙŠÙ…Ø©
              row[2],  // Ø§Ù„ÙƒÙ…ÙŠØ©
              row[1],  // Ø§Ù„Ø¨ÙŠØ§Ù†
              row[0],  // Ø±.Øª
              ''  
            ]);
          });

          // Add totals and footer
          invoiceData.push(['', '', '', '', '', '']);
          invoiceData.push([subtotal.toFixed(3), '', 'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ', '','']);
          invoiceData.push(['', '', '', '', '', '']);
          invoiceData.push(['', '', `Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø­Ø±ÙˆÙ: ${totalInWords}`, '', '']);
          invoiceData.push(['', '', '', '', '', '']);
          invoiceData.push(['', '', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯:', '', '']);
          invoiceData.push([' ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù†Ù‚Ø¯Ø§Ù‹ Ø£Ùˆ Ø¨ØµÙƒ Ù…ØµØ¯Ù‚ Ø¨Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¥Ø³Ù… Ø´Ø±ÙƒØ© Ø£Ù…Ø§Ø¯ÙŠÙŠÙˆØ³ Ù„ÙŠØ¨ÙŠØ§ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø£Ùˆ Ø¨Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© Ø±Ù‚Ù… 0900003088 Ù„Ø¯Ù‰ Ø§Ù„Ù…ØµØ±Ù Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ.', '', '', '', '', '']);
          invoiceData.push(['', '', '', '', '', '']);
          invoiceData.push(['', '', '', '', '', '']);
          invoiceData.push(['','','ÙˆØ§Ù„Ø³Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ Ø¹Ù„ÙŠÙƒÙ… Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù„Ø§Ù…', '', '']);
          invoiceData.push(['', '', '', '', '', '']);
          invoiceData.push(['.........................', '', '', '', '', '']);
          invoiceData.push(['Ù…Ø¯ÙŠØ± Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© Ùˆ Ø§Ù„Ù…Ø§Ù„ÙŠØ©', '', '', '', '', '']);

          // Create worksheet
          const invoiceSheet = XLSX.utils.aoa_to_sheet(invoiceData);

          if (!invoiceSheet['!ref']) invoiceSheet['!ref'] = 'A1:F35';

          // MATCH EXACT COLUMN WIDTHS from invoiceWithBillNumber.html
          invoiceSheet['!cols'] = [
            { width: 15 },
            { width: 10 },
            { width: 80 },
            { width: 10 },
            { width: 10 },
            { width: 15 }
          ];

          // MATCH EXACT MERGED CELLS from invoiceWithBillNumber.html
          const baseRowForPayment = 18 + serviceRows.length;

          if (!invoiceSheet['!merges']) invoiceSheet['!merges'] = [];

          invoiceSheet['!merges'].push(
            // Company name row (row 2, index 2)
            { s: { r: 2, c: 0 }, e: { r: 2, c: 3 } },
            // Ø§Ù„ØªØ§Ø±ÙŠØ® row (row 4) - merge columns A & B
            { s: { r: 4, c: 0 }, e: { r: 4, c: 1 } },
            // Ø±Ù‚Ù… Ø§Ù„Ù…ÙƒØªØ¨ row (row 8) - merge columns A & B
            { s: { r: 8, c: 0 }, e: { r: 8, c: 1 } },
            // Ø§Ù„Ø§Ø®ÙˆØ© row (row 6) - merge columns C & D
            { s: { r: 6, c: 2 }, e: { r: 6, c: 3 } },
            // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙŠØ© row (row 8) - merge columns C & D
            { s: { r: 8, c: 2 }, e: { r: 8, c: 3 } },
            // Ù†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… row (row 13) - merge columns C & D
            { s: { r: 13, c: 2 }, e: { r: 13, c: 3 } },
            // ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… row (row 11) - merge columns A & B
            { s: { r: 11, c: 0 }, e: { r: 11, c: 1 } },
            { s: { r: baseRowForPayment + 5, c: 2 }, e: { r: baseRowForPayment + 5, c: 3 } },
            // Payment method - ALL IN ONE ROW
            { s: { r: baseRowForPayment + 6, c: 0 }, e: { r: baseRowForPayment + 7, c: 3 } },
            // Signature line (.........................)
            { s: { r: baseRowForPayment + 11, c: 0 }, e: { r: baseRowForPayment + 11, c: 1 } },
            // Ù…Ø¯ÙŠØ± Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© Ùˆ Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            { s: { r: baseRowForPayment + 12, c: 0 }, e: { r: baseRowForPayment + 12, c: 1} }
          );

          // Set RTL text alignment
          const range = XLSX.utils.decode_range(invoiceSheet['!ref']);
          for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              if (!invoiceSheet[cellAddress]) continue;

              if (!invoiceSheet[cellAddress].s) invoiceSheet[cellAddress].s = {};
              invoiceSheet[cellAddress].s.alignment = {
                horizontal: 'center',
                vertical: 'center',
                readingOrder: 2
              };
            }
          }

          // Specifically ensure the "ÙˆØ§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…" text is centered
          const salamRowIndex = baseRowForPayment + 9;
          const salamCellAddress = XLSX.utils.encode_cell({ r: salamRowIndex, c: 2 });
          if (invoiceSheet[salamCellAddress]) {
            invoiceSheet[salamCellAddress].s = {
              alignment: {
                horizontal: 'center',
                vertical: 'center',
                readingOrder: 2
              }
            };
          }

          // Create clean sheet name
          const cleanOfficeId = office.officeId
            .replace(/[^\w\s]/gi, "")
            .substring(0, 31);
          XLSX.utils.book_append_sheet(
            invoiceWorkbook,
            invoiceSheet,
            `ÙØ§ØªÙˆØ±Ø©_${cleanOfficeId}`
          );

          // Add to summary
          const monthsText = Array.from(months).sort().join(", ") || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          summaryData.push([
            office.officeId,
            office.companyName,
            office.arabicName,
            office.services.length,
            monthsText,
            formatNumber(subtotal),
            "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©",
          ]);
        });

        // Create summary sheet
        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        summarySheet["!cols"] = [
          { width: 15 },
          { width: 30 },
          { width: 30 },
          { width: 15 },
          { width: 20 },
          { width: 20 },
          { width: 30 },
        ];
        XLSX.utils.book_append_sheet(
          invoiceWorkbook,
          summarySheet,
          "Ù…Ù„Ø®Øµ_Ø§Ù„ÙÙˆØ§ØªÙŠØ±"
        );

        // Move summary to first position
        const sheetNames = invoiceWorkbook.SheetNames;
        const summaryIndex = sheetNames.indexOf("Ù…Ù„Ø®Øµ_Ø§Ù„ÙÙˆØ§ØªÙŠØ±");
        if (summaryIndex > 0) {
          sheetNames.splice(summaryIndex, 1);
          sheetNames.unshift("Ù…Ù„Ø®Øµ_Ø§Ù„ÙÙˆØ§ØªÙŠØ±");
        }
      }

      function displayResults() {
        const offices = Object.values(processedData);
        let totalAmount = 0;

        let html = `<div class="summary-card">`;
        html += `<h4>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${offices.length} ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† ${uploadedFiles.length} Ù…Ù„Ù</h4>`;
        html += `<div class="table-container"><table><thead><tr><th>Ø±Ù…Ø² Ø§Ù„Ù…ÙƒØªØ¨</th><th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</th><th>Ø§Ù„Ø£Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody>`;

        offices.forEach((office) => {
          const groupedServices = {};
          office.services.forEach((service) => {
            const baseDescription = service.description.replace(
              /\s*Ù„Ø´Ù‡Ø±\s*\d+\s*$/,
              ""
            );
            if (!groupedServices[baseDescription]) {
              groupedServices[baseDescription] = {
                price: 0,
                months: new Set(),
              };
            }
            groupedServices[baseDescription].price += service.price;
            if (service.month)
              groupedServices[baseDescription].months.add(service.month);
          });

          const total = Object.values(groupedServices).reduce(
            (sum, g) => sum + g.price,
            0
          );
          totalAmount += total;

          const allMonths = new Set();
          Object.values(groupedServices).forEach((g) => {
            g.months.forEach((m) => allMonths.add(m));
          });

          const monthsDisplay =
            Array.from(allMonths)
              .sort()
              .map((m) => `<span class="month-badge">${m}</span>`)
              .join(" ") || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

          html += `<tr>
                    <td><span class="office-id">${office.officeId}</span></td>
                    <td>${office.companyName}</td>
                    <td>${office.arabicName}</td>
                    <td>${Object.keys(groupedServices).length}</td>
                    <td>${monthsDisplay}</td>
                    <td>${formatNumber(total)} Ø¯.Ù„</td>
                </tr>`;
        });

        html += `</tbody></table></div>`;
        html += `<h4 style="color: #28a745; margin-top: 1rem;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${formatNumber(
          totalAmount
        )} Ø¯.Ù„</h4>`;
        html += `</div>`;

        summaryContent.innerHTML = html;
      }

      downloadBtn.addEventListener("click", () => {
        if (!invoiceWorkbook) {
          alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù„ØªØ­Ù…ÙŠÙ„");
          return;
        }
        
        const startingNumber = parseInt(document.getElementById("startingInvoiceNumber").value) || 1;
        const officeCount = Object.keys(processedData).length;
        const lastBillNumber = startingNumber + officeCount - 1;
        
        XLSX.writeFile(invoiceWorkbook, `ÙÙˆØ§ØªÙŠØ±_Ø£Ù…Ø§Ø¯ÙŠÙˆØ³_${startingNumber}-${lastBillNumber}.xlsx`);
      });
    </script>
</body>
</html>
