<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amosh Bills Invoice Generator</title>
    <style>
      body {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        direction: rtl;
      }

      .container {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 2rem;
      }

      .upload-section {
        margin: 2rem 0;
        padding: 2rem;
        border: 2px dashed #ccc;
        border-radius: 8px;
        background: #f9f9f9;
      }

      .file-input {
        margin: 1rem 0;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
      }

      .file-list {
        margin-top: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 6px;
        display: none;
      }

      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        margin: 0.3rem 0;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #dee2e6;
      }

      .file-name {
        font-weight: 500;
        color: #495057;
        flex-grow: 1;
      }

      .remove-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
      }

      .remove-btn:hover {
        background: #c82333;
      }

      .add-more-btn {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 0.5rem;
      }

      .process-btn,
      .download-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        margin: 0.5rem;
      }

      .process-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .download-btn {
        background: #007cba;
      }

      .results-section {
        margin-top: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        margin: 1rem 0;
      }

      th,
      td {
        padding: 10px;
        text-align: right;
        border: 1px solid #ddd;
      }

      th {
        background: #f5f5f5;
        font-weight: 600;
      }

      .progress {
        margin: 1rem 0;
        padding: 1rem;
        background: #e7f3ff;
        border-radius: 6px;
        display: none;
      }

      .summary-card {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        margin: 1rem 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .file-counter {
        background: #28a745;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-right: 10px;
      }

      .month-badge {
        background: #ffc107;
        color: #333;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin: 0 2px;
      }

      .invoice-number-section {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: #e3f2fd;
        border-radius: 8px;
        border: 2px solid #2196f3;
      }

      .invoice-number-section label {
        display: block;
        font-weight: 600;
        color: #1976d2;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
      }

      .invoice-number-section input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #2196f3;
        border-radius: 6px;
        font-size: 1.1rem;
        text-align: center;
        font-weight: bold;
        background: white;
      }

      .invoice-number-section input:focus {
        outline: none;
        border-color: #1565c0;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      .invoice-number-section .hint {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <nav
      style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem 0;
        margin: -2rem -2rem 2rem -2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      "
    >
      <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem">
        <h2
          style="
            color: white;
            margin: 0 0 1rem 0;
            text-align: center;
            font-size: 1.5rem;
          "
        >
          Amadeus Reports Processing Suite
        </h2>
        <h2
          style="
            color: white;
            margin: 0 0 1rem 0;
            text-align: center;
            font-size: 1.5rem;
            direction: rtl;
          "
        >
          Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ù…Ø§Ø¯ÙŠÙˆØ³
        </h2>
        <div
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
          "
        >
          <a
            href="ATC&MPT.html"
            style="
              background: rgba(255, 255, 255, 0.2);
              color: white;
              text-decoration: none;
              padding: 8px 16px;
              border-radius: 25px;
              font-size: 0.9rem;
              font-weight: 500;
              transition: all 0.3s ease;
              border: 1px solid rgba(255, 255, 255, 0.3);
            "
            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
          >
            ATC & MPT Reports
          </a>
          <a
            href="wep.html"
            style="
              background: rgba(255, 255, 255, 0.2);
              color: white;
              text-decoration: none;
              padding: 8px 16px;
              border-radius: 25px;
              font-size: 0.9rem;
              font-weight: 500;
              transition: all 0.3s ease;
              border: 1px solid rgba(255, 255, 255, 0.3);
            "
            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
          >
            WEP Reports
          </a>
          <a
            href="pnr.html"
            style="
              background: rgba(255, 255, 255, 0.2);
              color: white;
              text-decoration: none;
              padding: 8px 16px;
              border-radius: 25px;
              font-size: 0.9rem;
              font-weight: 500;
              transition: all 0.3s ease;
              border: 1px solid rgba(255, 255, 255, 0.3);
            "
            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
          >
            PNR Reports
          </a>
          <a
            href="mpe.html"
            style="
              background: rgba(255, 255, 255, 0.2);
              color: white;
              text-decoration: none;
              padding: 8px 16px;
              border-radius: 25px;
              font-size: 0.9rem;
              font-weight: 500;
              transition: all 0.3s ease;
              border: 1px solid rgba(255, 255, 255, 0.3);
            "
            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
          >
            MPE Reports
          </a>
          <a
            href="invoice.html"
            style="
              background: rgba(255, 255, 255, 0.2);
              color: white;
              text-decoration: none;
              padding: 8px 16px;
              border-radius: 25px;
              font-size: 0.9rem;
              font-weight: 500;
              transition: all 0.3s ease;
              border: 1px solid rgba(255, 255, 255, 0.3);
            "
            onmouseover="this.style.background='rgba(255,255,255,0.3)'"
            onmouseout="this.style.background='rgba(255,255,255,0.2)'"
          >
            Consolidator Ø§Ù„Ù…ÙˆØ­Ø¯
          </a>
          <a
            href="#"
            style="
              background: rgba(255, 255, 255, 0.4);
              color: white;
              text-decoration: none;
              padding: 8px 16px;
              border-radius: 25px;
              font-size: 0.9rem;
              font-weight: 600;
              transition: all 0.3s ease;
              border: 2px solid rgba(255, 255, 255, 0.6);
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
              pointer-events: none;
            "
          >
            Invoice Generator Ù…ÙˆÙ„Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
          </a>
        </div>
        <p
          style="
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin: 1rem 0 0 0;
            font-size: 0.85rem;
          "
        >
          Generate individual invoices from Amosh bills files with automatic
          month extraction
        </p>
        <p
          style="
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin: 1rem 0 0 0;
            font-size: 0.85rem;
            direction: rtl;
          "
        >
          Ø¥Ù†Ø´Ø§Ø¡ ÙÙˆØ§ØªÙŠØ± ÙØ±Ø¯ÙŠØ© Ù…Ù† Ù…Ù„ÙØ§Øª Amosh bills Ù…Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø´Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        </p>
      </div>
    </nav>

    <div class="container">
      <h1>Ù…ÙˆÙ„Ø¯ ÙÙˆØ§ØªÙŠØ± Amosh - Amosh Invoice Generator</h1>
      <p style="text-align: center; color: #666">
        ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¢Ù† Ù…Ù„ÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø´Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      </p>

      <div class="upload-section">
        <h3>
          ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Amosh bills.xlsx
          <span class="file-counter" id="fileCounter">0</span>
        </h3>
        <input
          type="file"
          id="amoshFile"
          class="file-input"
          accept=".xlsx,.xls"
          multiple
        />
        <button
          class="add-more-btn"
          onclick="document.getElementById('amoshFile').click()"
        >
          Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
        </button>
        <div class="file-list" id="fileList"></div>
        <br />

        <!-- Invoice Number Input Section -->
        <div class="invoice-number-section">
          <label for="startingInvoiceNumber">ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰:</label>
          <input
            type="number"
            id="startingInvoiceNumber"
            placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ù…Ø«Ø§Ù„: 30)"
            min="1"
            value="1"
          />
          <div class="hint">
            ğŸ’¡ Ø³ÙŠØªÙ… ØªØ±Ù‚ÙŠÙ… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ù…ØªØªØ§Ù„ÙŠ Ù„ÙƒÙ„ Ù…ÙƒØªØ¨
          </div>
        </div>

        <button id="processBtn" class="process-btn" disabled>
          Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
        </button>
      </div>

      <div class="progress" id="progressDiv">
        <p id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
      </div>

      <div id="resultsSection" class="results-section">
        <h3>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ - Results</h3>
        <div id="summaryContent"></div>
        <button id="downloadBtn" class="download-btn">
          ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ÙÙˆØ§ØªÙŠØ± - Download Invoices
        </button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
      let uploadedFiles = [];
      let processedData = {};
      let invoiceWorkbook = null;

      const amoshFile = document.getElementById("amoshFile");
      const processBtn = document.getElementById("processBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const progressDiv = document.getElementById("progressDiv");
      const progressText = document.getElementById("progressText");
      const resultsSection = document.getElementById("resultsSection");
      const summaryContent = document.getElementById("summaryContent");
      const fileList = document.getElementById("fileList");
      const fileCounter = document.getElementById("fileCounter");

      amoshFile.addEventListener("change", (e) => {
        handleFileUpload(e.target.files);
        e.target.value = ""; // Clear so same file can be added again
      });

      function handleFileUpload(files) {
        Array.from(files).forEach((file) => {
          // Check for duplicates
          const isDuplicate = uploadedFiles.some(
            (f) => f.name === file.name && f.size === file.size
          );
          if (!isDuplicate) {
            uploadedFiles.push(file);
          }
        });
        updateFileDisplay();
      }

      function updateFileDisplay() {
        fileCounter.textContent = uploadedFiles.length;
        processBtn.disabled = uploadedFiles.length === 0;

        if (uploadedFiles.length === 0) {
          fileList.style.display = "none";
          return;
        }

        fileList.style.display = "block";
        fileList.innerHTML = uploadedFiles
          .map(
            (file, index) => `
                <div class="file-item">
                    <span class="file-name">${file.name}</span>
                    <button class="remove-btn" onclick="removeFile(${index})">Ø­Ø°Ù</button>
                </div>
            `
          )
          .join("");
      }

      function removeFile(index) {
        uploadedFiles.splice(index, 1);
        updateFileDisplay();
      }

      processBtn.addEventListener("click", async () => {
        if (uploadedFiles.length === 0) return;

        progressDiv.style.display = "block";
        processBtn.disabled = true;

        try {
          await processAllAmoshFiles();
          generateInvoices();
          displayResults();
          resultsSection.style.display = "block";
        } catch (error) {
          alert("Ø®Ø·Ø£: " + error.message);
          console.error(error);
        } finally {
          progressDiv.style.display = "none";
          processBtn.disabled = false;
        }
      });

      async function processAllAmoshFiles() {
        processedData = {};

        for (let i = 0; i < uploadedFiles.length; i++) {
          const file = uploadedFiles[i];
          progressText.textContent = `Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù ${i + 1}/${
            uploadedFiles.length
          }: ${file.name}`;
          await processAmoshFile(file);
        }

        console.log("Processed offices:", Object.keys(processedData).length);
      }

      async function processAmoshFile(file) {
        const data = await readFile(file);
        const workbook = XLSX.read(data);

        const serviceSheets = {
          ATC: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ°Ø§ÙƒØ± ATC",
          "MPE ": "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPE",
          MPE: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPE",
          MPT: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø±Ø­Ù„Ø© Ù…Ø¹ÙŠÙ†Ø© MPT",
          PNR: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª PNR",
          "Web Trax": "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© WEP",
          " AUTTP ": "Amadeus Unused e-Document",
          AUTTP: "Amadeus Unused e-Document",
          "AOS Std Implementation Fee": "AOS Std Implementation Fee",
        };

        for (let [sheetName, serviceDescription] of Object.entries(
          serviceSheets
        )) {
          if (workbook.Sheets[sheetName]) {
            progressText.textContent = `Ù…Ø¹Ø§Ù„Ø¬Ø© ${sheetName} Ù…Ù† ${file.name}...`;
            processSheet(
              workbook.Sheets[sheetName],
              serviceDescription,
              sheetName
            );
          }
        }
      }

      function extractMonthFromHeader(headerText) {
        if (!headerText) return "";

        const monthMap = {
          ÙŠÙ†Ø§ÙŠØ±: "01",
          january: "01",
          jan: "01",
          ÙØ¨Ø±Ø§ÙŠØ±: "02",
          february: "02",
          feb: "02",
          Ù…Ø§Ø±Ø³: "03",
          march: "03",
          mar: "03",
          Ø£Ø¨Ø±ÙŠÙ„: "04",
          Ø¥Ø¨Ø±ÙŠÙ„: "04",
          april: "04",
          apr: "04",
          Ù…Ø§ÙŠÙˆ: "05",
          Ù…Ø§ÙŠ: "05",
          may: "05",
          ÙŠÙˆÙ†ÙŠÙˆ: "06",
          ÙŠÙˆÙ†ÙŠÙ‡: "06",
          june: "06",
          jun: "06",
          ÙŠÙˆÙ„ÙŠÙˆ: "07",
          ÙŠÙˆÙ„ÙŠÙ‡: "07",
          july: "07",
          jul: "07",
          Ø£ØºØ³Ø·Ø³: "08",
          Ø§ØºØ³Ø·Ø³: "08",
          august: "08",
          aug: "08",
          Ø³Ø¨ØªÙ…Ø¨Ø±: "09",
          september: "09",
          sep: "09",
          Ø£ÙƒØªÙˆØ¨Ø±: "10",
          Ø§ÙƒØªÙˆØ¨Ø±: "10",
          october: "10",
          oct: "10",
          Ù†ÙˆÙÙ…Ø¨Ø±: "11",
          november: "11",
          nov: "11",
          Ø¯ÙŠØ³Ù…Ø¨Ø±: "12",
          december: "12",
          dec: "12",
        };

        const lowerText = headerText.toLowerCase();

        for (let [monthName, monthNum] of Object.entries(monthMap)) {
          if (lowerText.includes(monthName.toLowerCase())) {
            return monthNum;
          }
        }

        return "";
      }

      function processSheet(sheet, serviceDescription, sheetName) {
        const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

        // Extract month from first row header
        let monthNumber = "";
        if (data.length > 0 && data[0][0]) {
          monthNumber = extractMonthFromHeader(data[0][0].toString());
        }

        // Find header row (contains "Office ID")
        let headerRowIndex = -1;
        for (let i = 0; i < data.length; i++) {
          if (data[i].includes("Office ID")) {
            headerRowIndex = i;
            break;
          }
        }

        if (headerRowIndex === -1) return;

        const headers = data[headerRowIndex];
        const officeIdIndex = headers.indexOf("Office ID");
        const companyNameIndex = headers.indexOf("Company Name");
        const arabicNameIndex = headers.indexOf("Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©");
        const qtyIndex =
          headers.indexOf("Ø§Ù„ÙƒÙ…ÙŠØ©") !== -1
            ? headers.indexOf("Ø§Ù„ÙƒÙ…ÙŠØ©")
            : headers.indexOf("Qty");
        const priceIndex =
          headers.indexOf("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹") !== -1
            ? headers.indexOf("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹")
            : headers.indexOf("Sales Price");

        // Process data rows
        for (let i = headerRowIndex + 1; i < data.length; i++) {
          const row = data[i];
          const officeId = row[officeIdIndex];
          const companyName = row[companyNameIndex];
          const arabicName = row[arabicNameIndex];
          const quantity = parseFloat(row[qtyIndex]) || 0;
          const price = parseFloat(row[priceIndex]) || 0;

          if (!officeId || (!quantity && !price)) continue;

          if (!processedData[officeId]) {
            processedData[officeId] = {
              officeId: officeId,
              companyName: companyName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
              arabicName: arabicName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
              services: [],
            };
          }

          if (quantity > 0 || price > 0) {
            // Add month to service description
            let descriptionWithMonth = serviceDescription;
            if (monthNumber) {
              descriptionWithMonth += ` Ù„Ø´Ù‡Ø± ${monthNumber}`;
            }

            processedData[officeId].services.push({
              description: descriptionWithMonth,
              quantity: quantity,
              price: price,
              sheet: sheetName,
              month: monthNumber,
            });
          }
        }
      }

      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      function formatNumber(num) {
        const parts = num.toFixed(3).split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
      }

      function numberToArabic(num) {
        const ones = [
          "",
          "ÙˆØ§Ø­Ø¯",
          "Ø§Ø«Ù†Ø§Ù†",
          "Ø«Ù„Ø§Ø«Ø©",
          "Ø£Ø±Ø¨Ø¹Ø©",
          "Ø®Ù…Ø³Ø©",
          "Ø³ØªØ©",
          "Ø³Ø¨Ø¹Ø©",
          "Ø«Ù…Ø§Ù†ÙŠØ©",
          "ØªØ³Ø¹Ø©",
        ];
        const tens = [
          "",
          "",
          "Ø¹Ø´Ø±ÙˆÙ†",
          "Ø«Ù„Ø§Ø«ÙˆÙ†",
          "Ø£Ø±Ø¨Ø¹ÙˆÙ†",
          "Ø®Ù…Ø³ÙˆÙ†",
          "Ø³ØªÙˆÙ†",
          "Ø³Ø¨Ø¹ÙˆÙ†",
          "Ø«Ù…Ø§Ù†ÙˆÙ†",
          "ØªØ³Ø¹ÙˆÙ†",
        ];
        const teens = [
          "Ø¹Ø´Ø±Ø©",
          "Ø£Ø­Ø¯ Ø¹Ø´Ø±",
          "Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±",
          "Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±",
          "Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±",
          "Ø®Ù…Ø³Ø© Ø¹Ø´Ø±",
          "Ø³ØªØ© Ø¹Ø´Ø±",
          "Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±",
          "Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±",
          "ØªØ³Ø¹Ø© Ø¹Ø´Ø±",
        ];
        const hundreds = [
          "",
          "Ù…Ø§Ø¦Ø©",
          "Ù…Ø¦ØªØ§Ù†",
          "Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©",
          "Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©",
          "Ø®Ù…Ø³Ù…Ø§Ø¦Ø©",
          "Ø³ØªÙ…Ø§Ø¦Ø©",
          "Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©",
          "Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©",
          "ØªØ³Ø¹Ù…Ø§Ø¦Ø©",
        ];

        function convertInteger(n) {
          if (n === 0) return "ØµÙØ±";
          let result = "";
          let needsWaw = false;

          if (n >= 1000) {
            const thousands = Math.floor(n / 1000);
            if (thousands === 1) {
              result += "Ø£Ù„Ù";
            } else if (thousands === 2) {
              result += "Ø£Ù„ÙØ§Ù†";
            } else if (thousands >= 3 && thousands <= 10) {
              result += ones[thousands] + " Ø¢Ù„Ø§Ù";
            } else if (thousands >= 11 && thousands <= 99) {
              // Handle tens of thousands
              result += convertInteger(thousands) + " Ø£Ù„Ù";
            } else if (thousands >= 100) {
              // Handle hundreds of thousands
              result += convertInteger(thousands) + " Ø£Ù„Ù";
            }
            needsWaw = true;
            n %= 1000;
          }

          if (n >= 100) {
            if (needsWaw && n > 0) result += " Ùˆ";
            result += hundreds[Math.floor(n / 100)];
            needsWaw = true;
            n %= 100;
          }

          if (n >= 20) {
            if (needsWaw) result += " Ùˆ";
            const onesDigit = n % 10;
            const tensDigit = Math.floor(n / 10);
            if (onesDigit !== 0)
              result += ones[onesDigit] + " Ùˆ" + tens[tensDigit];
            else result += tens[tensDigit];
          } else if (n >= 10) {
            if (needsWaw) result += " Ùˆ";
            result += teens[n - 10];
          } else if (n > 0) {
            if (needsWaw) result += " Ùˆ";
            result += ones[n];
          }

          return result.trim();
        }

        // Split into integer and decimal parts
        const integerPart = Math.floor(num);
        const decimalPart = Math.round((num - integerPart) * 1000);

        let result = "ÙÙ‚Ø· ";
        result += convertInteger(integerPart) + " Ø¯ÙŠÙ†Ø§Ø±";

        if (decimalPart > 0) {
          result += " Ùˆ" + decimalPart + " Ø¯Ø±Ù‡Ù…";
        }

        result += " Ù„Ø§ØºÙŠØ±";
        return result;
      }

      function getCurrentDateArabic() {
        const date = new Date();
        const months = [
          "ÙŠÙ†Ø§ÙŠØ±",
          "ÙØ¨Ø±Ø§ÙŠØ±",
          "Ù…Ø§Ø±Ø³",
          "Ø£Ø¨Ø±ÙŠÙ„",
          "Ù…Ø§ÙŠÙˆ",
          "ÙŠÙˆÙ†ÙŠÙˆ",
          "ÙŠÙˆÙ„ÙŠÙˆ",
          "Ø£ØºØ³Ø·Ø³",
          "Ø³Ø¨ØªÙ…Ø¨Ø±",
          "Ø£ÙƒØªÙˆØ¨Ø±",
          "Ù†ÙˆÙÙ…Ø¨Ø±",
          "Ø¯ÙŠØ³Ù…Ø¨Ø±",
        ];
        return `${date.getDate()} ${
          months[date.getMonth()]
        } ${date.getFullYear()}`;
      }

      function generateInvoices() {
        progressText.textContent = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙˆØ§ØªÙŠØ±...";

        invoiceWorkbook = XLSX.utils.book_new();
        const offices = Object.values(processedData).sort((a, b) =>
          a.officeId.localeCompare(b.officeId)
        );

        const summaryData = [
          [
            "",
            "Ù…Ù„Ø®Øµ ÙÙˆØ§ØªÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ØªØ¨ - All Offices Summary",
            "",
            "",
            "",
            "",
            "",
          ],
          ["", "", "", "", "", "", ""],
          [
            "Ø±Ù…Ø² Ø§Ù„Ù…ÙƒØªØ¨",
            "Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨",
            "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ",
            "Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª",
            "Ø§Ù„Ø£Ø´Ù‡Ø±",
            "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
            "Ø§Ù„Ø­Ø§Ù„Ø©",
          ],
          ["", "", "", "", "", "", ""],
        ];

        // Get starting invoice number
        let startingNumber =
          parseInt(document.getElementById("startingInvoiceNumber").value) || 1;
        let currentInvoiceNumber = startingNumber;

        offices.forEach((office) => {
          const currentDate = getCurrentDateArabic();
          const currentYear = new Date().getFullYear();

          let subtotal = 0;
          let rowCounter = 1;
          const serviceRows = [];
          const months = new Set();

          // Group services by base description (without month)
          const groupedServices = {};
          office.services.forEach((service) => {
            // Extract base service name without month
            const baseDescription = service.description.replace(
              /\s*Ù„Ø´Ù‡Ø±\s*\d+\s*$/,
              ""
            );

            if (!groupedServices[baseDescription]) {
              groupedServices[baseDescription] = {
                quantity: 0,
                price: 0,
                months: new Set(),
              };
            }

            groupedServices[baseDescription].quantity += service.quantity;
            groupedServices[baseDescription].price += service.price;
            if (service.month) {
              groupedServices[baseDescription].months.add(service.month);
              months.add(service.month);
            }
          });

          // Create service rows with combined months
          Object.keys(groupedServices)
            .sort()
            .forEach((baseDescription) => {
              const group = groupedServices[baseDescription];
              const monthsArray = Array.from(group.months).sort();

              let finalDescription = baseDescription;
              if (monthsArray.length > 0) {
                finalDescription += ` Ù„Ø´Ù‡Ø± ${monthsArray.join(",")}`;
              }

              serviceRows.push([
                rowCounter++,
                finalDescription,
                group.quantity,
                formatNumber(group.price),
              ]);
              subtotal += group.price;
            });

          const totalInWords = numberToArabic(subtotal);

          const invoiceData = [
            ["", "", "", "", "", ""],
            ["", "", "", "", "", ""],
            ["", "", "", "Ø´Ø±ÙƒØ© Ø£Ù…Ø§Ø¯ÙŠÙˆØ³ Ù„ÙŠØ¨ÙŠØ§ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©", "", ""],
            ["", "", "", "", "", ""],
          ];

          const dateRowIndex = invoiceData.length;
          invoiceData.push(["", `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${currentDate}`, "", "", "", ""]);
          invoiceData.push(["", "", "", "", "", ""]);

          const brothersRowIndex = invoiceData.length;
          invoiceData.push([
            "",
            "",
            "",
            `Ø§Ù„Ø§Ø®ÙˆØ© / ${office.arabicName}`,
            "",
            "",
          ]);

          invoiceData.push(["", "", "", "", "", ""]);

          const greetingRowIndex = invoiceData.length;
          invoiceData.push([
            "",
            `Ø±Ù‚Ù… Ø§Ù„Ù…ÙƒØªØ¨: ${office.officeId}`,
            "",
            "Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙŠØ© ØŒØŒØŒ",
            "",
            "",
          ]);

          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push(["", "", "", "", "", ""]);

          const billNumberRowIndex = invoiceData.length;
          invoiceData.push([
            "",
            `ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: ${currentInvoiceNumber} / ${currentYear}`,
            "",
            "",
            "",
            "",
          ]);
          currentInvoiceNumber++; // Increment for next invoice
          invoiceData.push(["", "", "", "", "", ""]);

          const requestRowIndex = invoiceData.length;
          invoiceData.push([
            "",
            "",
            "",
            "Ù†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø³Ø¯Ø§Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠÙ†Ø© Ø£Ø¯Ù†Ø§Ù‡ :",
            "",
            "",
          ]);

          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push(["", "Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø¯.Ù„)", "Ø§Ù„ÙƒÙ…ÙŠØ©", "Ø§Ù„Ø¨ÙŠØ§Ù†", "Ø±.Øª", ""]);
          invoiceData.push(["", "", "", "", "", ""]);

          serviceRows.forEach((row) => {
            invoiceData.push(["", row[3], row[2], row[1], row[0], ""]);
          });

          const totalRowIndex = invoiceData.length;
          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push([
            "",
            formatNumber(subtotal),
            "",
            "Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ",
            "",
            "",
          ]);
          invoiceData.push(["", "", "", "", "", ""]);

          const amountWordsRowIndex = invoiceData.length;
          invoiceData.push([
            "",
            "",
            "",
            `Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø­Ø±ÙˆÙ: ${totalInWords}`,
            "",
            "",
          ]);

          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push(["", "", "", "", "", ""]);

          const paymentMethodRowIndex = invoiceData.length;
          invoiceData.push(["", "", "", "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯:", "", ""]);

          const paymentLine1RowIndex = invoiceData.length;
          invoiceData.push([
            "",
            "",
            "",
            "ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù†Ù‚Ø¯Ø§Ù‹ Ø£Ùˆ Ø¨ØµÙƒ Ù…ØµØ¯Ù‚ Ø¨Ø®Ø²ÙŠÙ†Ø© Ø§Ù„Ø´Ø±ÙƒØ©",
            "",
            "",
          ]);

          const paymentLine2RowIndex = invoiceData.length;
          invoiceData.push([
            "",
            "",
            "",
            "Ø¨Ø¥Ø³Ù… Ø´Ø±ÙƒØ© Ø£Ù…Ø§Ø¯ÙŠÙˆØ³ Ù„ÙŠØ¨ÙŠØ§ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©",
            "",
            "",
          ]);

          const paymentLine3RowIndex = invoiceData.length;
          invoiceData.push([
            "",
            "",
            "",
            "Ø£Ùˆ Ø¨Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© Ø±Ù‚Ù… 0900003088",
            "",
            "",
          ]);

          const paymentLine4RowIndex = invoiceData.length;
          invoiceData.push(["", "", "", "Ù„Ø¯Ù‰ Ø§Ù„Ù…ØµØ±Ù Ø§Ù„Ù„ÙŠØ¨ÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ.", "", ""]);

          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push([
            "",
            "",
            "",
            "ÙˆØ§Ù„Ø³Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù…",
            "",
            "",
          ]);
          invoiceData.push(["", "", "", "", "", ""]);
          invoiceData.push(["", "", ".........................", "", "", ""]);
          invoiceData.push([
            "",
            "",
            "Ù…Ø¯ÙŠØ± Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ© Ùˆ Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
            "",
            "",
            "",
          ]);

          const invoiceSheet = XLSX.utils.aoa_to_sheet(invoiceData);
          invoiceSheet["!cols"] = [
            { width: 20 },
            { width: 20 },
            { width: 20 },
            { width: 80 },
            { width: 35 },
            { width: 20 },
          ];

          // Merge cells
          if (!invoiceSheet["!merges"]) invoiceSheet["!merges"] = [];

          //Date Merge
          invoiceSheet["!merges"].push({
            s: { r: dateRowIndex, c: 2 },
            e: { r: dateRowIndex, c: 1 },
          });

          //Bill Number merge
          invoiceSheet["!merges"].push({
            s: { r: billNumberRowIndex, c: 2 },
            e: { r: billNumberRowIndex, c: 1 },
          });
          // Merge "Ø§Ù„Ø§Ø®ÙˆØ© / ..." (columns D-E, which are index 3-4)
          invoiceSheet["!merges"].push({
            s: { r: brothersRowIndex, c: 3 },
            e: { r: brothersRowIndex, c: 4 },
          });

          // Merge office ID (columns B-C, which are index 1-2)
          invoiceSheet["!merges"].push({
            s: { r: greetingRowIndex, c: 1 },
            e: { r: greetingRowIndex, c: 2 },
          });

          // Merge greeting (columns D-E, which are index 3-4)
          invoiceSheet["!merges"].push({
            s: { r: greetingRowIndex, c: 3 },
            e: { r: greetingRowIndex, c: 4 },
          });

          // Merge "Ù†Ø£Ù…Ù„ Ù…Ù†ÙƒÙ… Ø³Ø¯Ø§Ø¯..." (columns D-E, which are index 3-4)
          invoiceSheet["!merges"].push({
            s: { r: requestRowIndex, c: 3 },
            e: { r: requestRowIndex, c: 4 },
          });

          // Merge cells for payment method section (columns D-E, which are index 3-4)
          // "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯:"
          invoiceSheet["!merges"].push({
            s: { r: paymentMethodRowIndex, c: 3 },
            e: { r: paymentMethodRowIndex, c: 4 },
          });

          // Payment line 1
          invoiceSheet["!merges"].push({
            s: { r: paymentLine1RowIndex, c: 3 },
            e: { r: paymentLine1RowIndex, c: 4 },
          });

          // Payment line 2
          invoiceSheet["!merges"].push({
            s: { r: paymentLine2RowIndex, c: 3 },
            e: { r: paymentLine2RowIndex, c: 4 },
          });

          // Payment line 3
          invoiceSheet["!merges"].push({
            s: { r: paymentLine3RowIndex, c: 3 },
            e: { r: paymentLine3RowIndex, c: 4 },
          });

          // Payment line 4
          invoiceSheet["!merges"].push({
            s: { r: paymentLine4RowIndex, c: 3 },
            e: { r: paymentLine4RowIndex, c: 4 },
          });

          const cleanOfficeId = office.officeId
            .replace(/[^\w\s]/gi, "")
            .substring(0, 31);
          XLSX.utils.book_append_sheet(
            invoiceWorkbook,
            invoiceSheet,
            `ÙØ§ØªÙˆØ±Ø©_${cleanOfficeId}`
          );

          const monthsText = Array.from(months).sort().join(", ") || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          summaryData.push([
            office.officeId,
            office.companyName,
            office.arabicName,
            office.services.length,
            monthsText,
            formatNumber(subtotal),
            "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©",
          ]);
        });

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        summarySheet["!cols"] = [
          { width: 15 },
          { width: 30 },
          { width: 30 },
          { width: 15 },
          { width: 20 },
          { width: 20 },
          { width: 30 },
        ];
        XLSX.utils.book_append_sheet(
          invoiceWorkbook,
          summarySheet,
          "Ù…Ù„Ø®Øµ_Ø§Ù„ÙÙˆØ§ØªÙŠØ±"
        );

        const sheetNames = invoiceWorkbook.SheetNames;
        const summaryIndex = sheetNames.indexOf("Ù…Ù„Ø®Øµ_Ø§Ù„ÙÙˆØ§ØªÙŠØ±");
        if (summaryIndex > 0) {
          sheetNames.splice(summaryIndex, 1);
          sheetNames.unshift("Ù…Ù„Ø®Øµ_Ø§Ù„ÙÙˆØ§ØªÙŠØ±");
        }
      }

      function displayResults() {
        const offices = Object.values(processedData);
        let totalAmount = 0;

        let html = `<div class="summary-card">`;
        html += `<h4>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${offices.length} ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† ${uploadedFiles.length} Ù…Ù„Ù</h4>`;
        html += `<table><thead><tr><th>Ø±Ù…Ø² Ø§Ù„Ù…ÙƒØªØ¨</th><th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th><th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</th><th>Ø§Ù„Ø£Ø´Ù‡Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody>`;

        offices.forEach((office) => {
          // Group services to get unique count and total
          const groupedServices = {};
          office.services.forEach((service) => {
            const baseDescription = service.description.replace(
              /\s*Ù„Ø´Ù‡Ø±\s*\d+\s*$/,
              ""
            );
            if (!groupedServices[baseDescription]) {
              groupedServices[baseDescription] = {
                price: 0,
                months: new Set(),
              };
            }
            groupedServices[baseDescription].price += service.price;
            if (service.month)
              groupedServices[baseDescription].months.add(service.month);
          });

          const total = Object.values(groupedServices).reduce(
            (sum, g) => sum + g.price,
            0
          );
          totalAmount += total;

          const allMonths = new Set();
          Object.values(groupedServices).forEach((g) => {
            g.months.forEach((m) => allMonths.add(m));
          });

          const monthsDisplay =
            Array.from(allMonths)
              .sort()
              .map((m) => `<span class="month-badge">${m}</span>`)
              .join(" ") || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

          html += `<tr>
                    <td>${office.officeId}</td>
                    <td>${office.companyName}</td>
                    <td>${office.arabicName}</td>
                    <td>${Object.keys(groupedServices).length}</td>
                    <td>${monthsDisplay}</td>
                    <td>${formatNumber(total)} Ø¯.Ù„</td>
                </tr>`;
        });

        html += `</tbody></table>`;
        html += `<h4>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${formatNumber(
          totalAmount
        )} Ø¯.Ù„</h4>`;
        html += `</div>`;

        summaryContent.innerHTML = html;
      }

      downloadBtn.addEventListener("click", () => {
        if (!invoiceWorkbook) {
          alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù„ØªØ­Ù…ÙŠÙ„");
          return;
        }
        XLSX.writeFile(invoiceWorkbook, "ÙÙˆØ§ØªÙŠØ±_Ø£Ù…Ø§Ø¯ÙŠÙˆØ³_Amosh.xlsx");
      });
    </script>
  </body>
</html>
